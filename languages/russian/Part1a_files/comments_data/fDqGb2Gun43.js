/*1332960092,176820665*/

if (window.CavalryLogger) { CavalryLogger.start_js(["w7apk"]); }

__d("legacy:channel",["ChannelManager"],function(a,b,c,d){a.channel=a.channel||b('ChannelManager');},3);
__d("legacy:channel_manager",["ChannelManager"],function(a,b,c,d){a.channel_manager=a.channel_manager||b('ChannelManager');},3);
var Dock=window.Dock||copy_properties(new Arbiter(),{MIN_HEIGHT:140,INITIAL_FLYOUT_HEIGHT_OFFSET:10,init:function(a){this.init=bagofholding;this.rootEl=a;this.calculateViewportDimensions();this.calculateFlyoutHeightOffset();ChatQuietLinks.silence(this.rootEl);Event.listen(a,'click',this._onClick.bind(this));Event.listen(window,'resize',this._onWindowResize.bind(this));Toggler.subscribe(['show','hide'],function(b,c){var d=c.getActive();if(!DOM.contains(a,d))return;if(CSS.hasClass(d,'fbNub')){this.notifyNub(d,b);if(b==='show')this._resizeNubFlyout(d);}else{var e=Parent.byClass(d,'fbNubFlyout');if(e)CSS.conditionClass(e,'menuOpened',b==='show');}}.bind(this));this.inform('init',{},Arbiter.BEHAVIOR_PERSISTENT);},calculateViewportDimensions:function(){return (this.viewportDimensions=Vector2.getViewportDimensions());},calculateFlyoutHeightOffset:function(){this.flyoutHeightOffset=this.INITIAL_FLYOUT_HEIGHT_OFFSET+Vector2.getElementDimensions(this.rootEl).y;var a=ge('blueBar');if(a){var b=CSS.isFixed(a)?'viewport':'document';this.flyoutHeightOffset+=Vector2.getElementPosition(a,b).y+Vector2.getElementDimensions(a).y;}},toggle:function(a){var b=this._findFlyout(a);if(!b)return;this.subscribe('init',function(){Toggler.toggle(a);});},show:function(a){this.subscribe('init',function(){Toggler.show(a);});},showNub:function(a){CSS.show(a);},hide:function(a){this.subscribe('init',function(){var b=Toggler.getInstance(a);DOM.contains(a,b.getActive())&&b.hide();});},hideNub:function(a){CSS.hide(a);this.hide(a);},setUseMaxHeight:function(a,b){CSS.conditionClass(a,'maxHeight',b!==false);this._resizeNubFlyout(a);},_resizeNubFlyout:function(a){var b=this._findFlyout(a);if(!b||!(CSS.hasClass(a,'openToggler')||CSS.hasClass(a,'opened')))return;var c=DOM.find(b,'div.fbNubFlyoutOuter'),d=DOM.find(c,'div.fbNubFlyoutInner'),e=DOM.find(d,'div.fbNubFlyoutBody'),f=e.scrollTop,g=e.offsetHeight;CSS.setStyle(e,'height','auto');var h=Vector2.getElementPosition(b,'viewport'),i=Vector2.getElementDimensions(b),j=Vector2.getElementDimensions(e),k=Vector2.getElementDimensions(e.firstChild),l=Math.max(this.MIN_HEIGHT,this.viewportDimensions.y-this.flyoutHeightOffset)-(this.viewportDimensions.y-h.y-i.y);CSS.setStyle(b,'max-height',l+'px');CSS.setStyle(c,'max-height',l+'px');i=Vector2.getElementDimensions(b);var m=Vector2.getElementDimensions(d),n=m.y-j.y;if(i.y>n)CSS.setStyle(e,'height',(i.y-n)+'px');CSS.removeClass(b,'swapDirection');var o=Vector2.getElementPosition(b).x;CSS.conditionClass(b,'swapDirection',function(){if(o<0)return true;return (o+i.x>this.viewportDimensions.x);}.bind(this)());if(f+g>=j.y){e.scrollTop=j.y;}else e.scrollTop=f;this.notifyNub(a,'resize');},resizeAllFlyouts:function(){var a=DOM.scry(this.rootEl,'div.fbNub.openToggler');a=a.concat(DOM.scry(this.rootEl,'div.fbNub.opened'));var b=a.length;while(b--)this._resizeNubFlyout(a[b]);},_onClick:function(event){var a=event.getTarget(),b=Parent.byClass(a,'fbNub');if(b){if(Parent.byClass(a,'fbNubFlyoutTitlebar')){var c=Parent.byTag(a,'a');if(!c||!c.rel){this.hide(b);return false;}}this.notifyNub(b,'click');}},_onWindowResize:function(event){this.calculateViewportDimensions();this.resizeAllFlyouts();},_findFlyout:function(a){return (flyoutEl=CSS.hasClass(a,'fbNubFlyout')?a:DOM.scry(a,'div.fbNubFlyout')[0]||null);},registerNubController:function(a,b){DataStore.set(a,'dock:nub:controller',b);b.subscribe('nub/button/content-changed',this.inform.shield(this,'resize',a));b.subscribe('nub/flyout/content-changed',this._resizeNubFlyout.shield(this,a));},unregisterNubController:function(a){DataStore.remove(a,'dock:nub:controller');},notifyNub:function(a,b,c){var d=DataStore.get(a,'dock:nub:controller');d&&d.inform(b,c);}});
function NubController(){}Class.mixin(NubController,'Arbiter',{init:function(a){this.el=a;Dock.registerNubController(a,this);return this;},buttonContentChanged:function(){this.inform('nub/button/content-changed');},flyoutContentChanged:function(){this.inform('nub/flyout/content-changed');},hide:function(){Dock.hide(this.el);},show:function(){Dock.show(this.el);}});
__d("isRTL",[],function(a,b,c,d,e,f){function g(h){for(var i=0;i<h.length;i++){var j=h.charCodeAt(i);if(j>=48)return j>=1470&&j<=1920;}return false;}e.exports=g;});
__d("TextInputControl",["event-extensions","function-extensions","Class","DOMControl","Input","copyProperties"],function(a,b,c,d,e,f){b("event-extensions");b("function-extensions");var g=b("Class"),h=b("DOMControl"),i=b("Input"),j=b("copyProperties");function k(l){this.parent.construct(this,l);var m=this.getRoot(),n=function(){this.update.bind(this).defer();}.bind(this);Event.listen(m,{keydown:n,paste:n});}g.extend(k,h);j(k.prototype,{setMaxLength:function(l){i.setMaxLength(this.getRoot(),l);return this;},getValue:function(){return i.getValue(this.getRoot());},isEmpty:function(){return i.isEmpty(this.getRoot());},setValue:function(l){i.setValue(this.getRoot(),l);this.update();return this;},clear:function(){return this.setValue('');},setPlaceholderText:function(l){i.setPlaceholder(this.getRoot(),l);return this;}});e.exports=k;});
__d("TextMetrics",["array-extensions","function-extensions","css","DOM","FunctionUtils","ua"],function(a,b,c,d,e,f){b("array-extensions");b("function-extensions");var g=b("css"),h=b("DOM"),i=b("FunctionUtils"),j=b("ua"),k;function l(){if(typeof k==='undefined'){var n=h.create('div',{className:'webkitZoomTest'}),o=function(){h.appendContent(document.body,n);k=100/n.clientHeight;h.remove(n);};Event.listen(window,'resize',i.debounce(o,100));o();}return k;}function m(n){this._node=n;this._shadow=h.create('textarea',{className:'textMetrics'});var o=['fontSize','fontStyle','fontWeight','fontFamily','wordWrap'];o.forEach(function(q){g.setStyle(this._shadow,q,g.getStyle(n,q));}.bind(this));var p=g.getStyle(n,'lineHeight');if(j.chrome()||j.safari())p=Math.round(parseInt(p,10)*l())+'px';g.setStyle(this._shadow,'lineHeight',p);document.body.appendChild(this._shadow);}m.prototype.measure=function(){var n=this._node,o=this._shadow,p=n.clientWidth-g.getStyleFloat(n,'paddingLeft')-g.getStyleFloat(n,'paddingRight');g.setStyle(o,'width',p+'px');o.value=n.value+'...';return {width:o.scrollWidth,height:o.scrollHeight};};m.prototype.destroy=function(){h.remove(this._shadow);};e.exports=m;});
__d("TextAreaControl",["event-extensions","function-extensions","Arbiter","ArbiterMixin","Class","css","DOMControl","TextInputControl","TextMetrics"],function(a,b,c,d,e,f){b("event-extensions");b("function-extensions");var g=b("Arbiter"),h=b("ArbiterMixin"),i=b("Class"),j=b("css"),k=b("DOMControl"),l=b("TextInputControl"),m=b("TextMetrics");function n(o){this.autogrow=j.hasClass(o,'uiTextareaAutogrow');this.parent.construct(this,o);this.width=null;Event.listen(o,'focus',this._handleFocus.bind(this));}i.extend(n,l);i.mixin(n,h,{setAutogrow:function(o){this.autogrow=o;return this;},onupdate:function(){this.parent.onupdate();if(this.autogrow){var o=this.getRoot();if(!this.metrics)this.metrics=new m(o);if(typeof this.initialHeight==='undefined'){this.isBorderBox=j.getStyle(o,'box-sizing')==='border-box'||j.getStyle(o,'-moz-box-sizing')==='border-box'||j.getStyle(o,'-webkit-box-sizing')==='border-box';this.borderBoxOffset=j.getStyleFloat(o,'padding-top')+j.getStyleFloat(o,'padding-bottom')+j.getStyleFloat(o,'border-top-width')+j.getStyleFloat(o,'border-bottom-width');this.initialHeight=o.offsetHeight-this.borderBoxOffset;}var p=this.metrics.measure(),q=Math.max(this.initialHeight,p.height);if(this.isBorderBox)q+=this.borderBoxOffset;if(q!==this.height){this.height=q;j.setStyle(o,'height',q+'px');g.inform('reflow');this.inform('resize');}}else if(this.metrics){this.metrics.destroy();this.metrics=null;}},resetHeight:function(){this.height=-1;this.update();},_handleFocus:function(){this.width=null;}});n.getInstance=function(o){return k.getInstance(o)||new n(o);};e.exports=n;});
__d("legacy:control-textarea",["TextAreaControl"],function(a,b,c,d){a.TextAreaControl=b('TextAreaControl');},3);
var Sound=(function(){var a={},b=null,c=false,d=null,e='so_sound_player',f='fb_sounds_playing2',g=['error','ended','pause'],h=null,i=null;function j(w){var x=URI(w);if(!x.getDomain())return URI(Env.static_base).setPath(x.getPath()).toString();return w;}function k(w){if(/\.mp3$/.test(w))return 'audio/mpeg';if(/\.og[ga]$/.test(w))return 'audio/ogg';return '';}function l(){try{var x=window.localStorage[f];if(x)x=JSON.parse(x);return x;}catch(w){return null;}}function m(w){window.localStorage[f]=JSON.stringify(w);}function n(w){var x=l(),y=60*1000;return x&&Math.abs(x[w]-Date.now())<y;}function o(w){var x=l()||{};x[w]=Date.now();m(x);var y=p(),z=function(){for(var ba=0;ba<g.length;ba++)y.removeEventListener(g[ba],z,false);x=l()||{};delete x[w];m(x);};for(var aa=0;aa<g.length;aa++)y.addEventListener(g[aa],z,false);}function p(){if(!Env.html5_audio)return null;if(!i){var w=document.createElement('audio');if(!w.canPlayType)return null;w.setAttribute('preload','auto');document.body.appendChild(w);i=w;}return i;}function q(){var w=document[e]||window[e];if(w)if(!w.playSound&&w.length)w=w[0];return (w&&w.playSound&&w.loopSound)?w:null;}function r(w,x,y,z){var aa={paths:x,sync:y,loop:z};w.contentWindow.postMessage(JSON.stringify(aa),'*');}function s(){var w=location.host;return w.replace(/^[^.]+/,'www');}function t(){return c;}function u(w,x,y){b={path:w,sync:x,loop:y};}function v(){c=true;if(b){var w=q();if(b.loop){w.loopSound(b.path,b.sync);}else w.playSound(b.path,b.sync);}Arbiter.unsubscribe(d);d=null;}return {init:function(w){w=$A(w);var x;for(var y=0;y<w.length;++y){x=w[y];if(a[x])return;}var z=p();for(y=0;z&&y<w.length;++y){x=w[y];if(z.canPlayType(x)){if(location.host!=s()){h=document.createElement('iframe');h.setAttribute('src','//'+s()+'/sound_iframe.php');h.style.display='none';document.body.appendChild(h);}a[x]=true;return;}}a['audio/mpeg']=true;if(q())return;try{d=Arbiter.subscribe('sound/ready',v);var ba=document.createElement('div');ba.id='sound_player_holder';document.body.appendChild(ba);var ca=new SWFObject('/swf/SoundPlayerHater.swf',e,'1px','1px',['9.0.159.0','10.0.22.87'],'#ffffff');ca.addParam('allowscriptaccess','always');ca.addParam('wmode','transparent');ca.addVariable('swf_id',e);ca.fallback_html=' ';ca.write(ba.id);window[e]=ca;}catch(aa){}},play:function(w,x,y){w=$A(w);var z=p(),aa,ba;for(var ca=0;z&&ca<w.length;++ca){aa=w[ca];ba=k(aa);if(!z.canPlayType(ba))continue;Sound.init([ba]);if(x&&h){r(h,[aa],x,y);return;}if(x&&n(aa))return;z.src=j(aa);if(y){z.setAttribute('loop','');}else z.removeAttribute('loop');z.play();x&&o(aa);return;}for(ca=0;ca<w.length;++ca){aa=j(w[ca]);ba=k(aa);if(ba!='audio/mpeg')continue;Sound.init([ba]);var da=q();if(!t()){u(aa,x,y);return;}else if(da){if(y){da.loopSound(aa,x);}else da.playSound(aa,x);return;}}},stop:function(w){w=$A(w);for(var x=0;x<w.length;++x){var y=j(w[x]),z=p(),aa=q();if(z&&z.src==y){z.pause();z.src=undefined;}else aa&&aa.stopSound(y);}}};})();
__d("ChatActivity",["Arbiter","AvailableList","AvailableListConstants","ChatConfig","copyProperties","event-extensions","JSLogger","math-extensions","MercuryThreads","PresenceState","UserActivity"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('ChatConfig'),k=b('copyProperties');b('event-extensions');var l=b('JSLogger'),m=b('math-extensions'),n=b('MercuryThreads'),o=b('PresenceState'),p=b('UserActivity'),q=j.get('activity_limit')||60000,r=j.get('idle_limit')||1800000,s=j.get('idle_poll_interval')||300000,t=l.create('chat_activity'),u=Date.now(),v=u,w=true;function x(){var ba=Date.now();return !!(w&&(ba-u<q));}var y=k(new g(),{isActive:x});function z(){var ba=u;u=Date.now();if(u-ba>r){t.debug('idle_to_active',ba);o.doSync();}y.inform('activity');}h.subscribe(i.ON_AVAILABILITY_CHANGED,function(){if(!h.isUserIdle())v=Date.now();});Event.listen(window,'focus',function(){w=true;z();});Event.listen(window,'blur',function(){w=false;});p.subscribe(function(){z();});function aa(ba){var ca=ba&&ba.at&&m.verifyNumber(ba.at);if(typeof ca!=='number')ca=null;return ca||0;}setInterval(function(){var ba=Date.now(),ca=aa(o.get()),da=Math.max(u,ca,v);if(ba-da>r){t.debug('idle',{cookie:ca,local:u,presence:v});y.inform('idle',ba-da);}},s);o.registerStateStorer(function(ba){var ca=aa(ba);if(ca<u)ba.at=u;return ba;});g.subscribe(l.DUMP_EVENT,function(ba,ca){ca.chat_activity={activity_limit:q,idle_limit:r,idle_poll_interval:s,last_active_time:u,last_global_active_time:v};});e.exports=y;});
__d("ChatSound",["MercuryParticipants","MercuryThreads"],function(a,b,c,d,e,f){var g=b('MercuryParticipants'),h=b('MercuryThreads'),i='chat_sound',j=512;window.Sound&&window.Sound.init(['audio/ogg','audio/mpeg']);function k(m){window.Sound.play(['/sound/pling.ogg','/sound/pling.mp3'],m,false);}function l(m){if(!window.localStorage||!m){k(true);return;}var n=window.localStorage.getItem(i);n=n||'';if(n.indexOf(''+m)!=-1)return;if(n.length>j){var o=n.lastIndexOf(' ',j/2);n=n.substr(0,o==-1?(j/2):o);}n=m+' '+n;window.localStorage.setItem(i,n);k(false);}e.exports={messageReceived:function(m){if(window.chatOptions&&window.chatOptions.getSetting('sound')&&window.Sound&&m.sender!=g.user)h.getThreadMeta(m.thread_id,function(n){n.is_canonical_user&&l(m.timestamp);});}};});
__d("ChatPrivacyActionController",["Arbiter","ChatVisibility","JSLogger","PresencePrivacy","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatVisibility'),i=b('JSLogger'),j=b('PresencePrivacy'),k=b('copyProperties'),l=function(m,n){this._userID=m;this._logger=i.create('blackbird');this._getState=function(){if(h.isOnline())return j.allows(this._userID)?l.NORMAL:l.BLOCKED;return l.OFFLINE;};this._togglePrivacy=function(){var o=this._getState();switch(this._getState()){case l.OFFLINE:if(h.isOnline()){this._logger.error('tabs_already_online');break;}this._logger.log('tabs_go_online',{tab_id:this._userID});h.goOnline(function(){if(!j.allows(this._userID)){if(this._getState()!==l.BLOCKED)this._logger.error('privacy_action_controller_blocked_inconsistency');this._togglePrivacy();}}.bind(this));break;case l.BLOCKED:j.allow(this._userID);this._logger.log('tabs_unblock',{tab_id:this._userID});break;case l.NORMAL:j.disallow(this._userID);this._logger.log('tabs_block',{tab_id:this._userID});break;}};(function(){var o=function(){n&&n(this._getState());}.bind(this);o();j.subscribe('privacy-changed',o);}.bind(this)).defer();};l.OFFLINE='offline';l.BLOCKED='blocked';l.NORMAL='normal';k(l.prototype,{togglePrivacy:function(){this._logger.log('gear_menu_toggle_privacy',{tab_id:this._userID});this._togglePrivacy();}});e.exports=l;});
__d("htmlHyperlink",["Env","StringEscape","UntrustedLink","URLScraper"],function(a,b,c,d,e,f){var g=b("Env"),h=b("StringEscape"),i=b("UntrustedLink"),j=b("URLScraper");function k(l,m,n,o){if(typeof l==='undefined'||!l.toString)return '';if(typeof m!=='function')m=h.htmlize;if(typeof n!=='function')n=h.htmlize;var l=l.toString(),p=[],q;while((q=j.match(l))){var r=l.indexOf(q);if(r>=0)p.push(m(l.substring(0,r)));var s=n(q),t=q.replace(/"/g,'%22');if(!(/^[a-z][a-z0-9\-+.]+:\/\//i.test(q)))t='http://'+t;p.push('<a target="_blank" rel="nofollow" href="'+t+'"');if(o){a.UntrustedLink=i;p.push(' onmousedown="UntrustedLink.bootstrap(this, \''+g.lhsh+'\', event)"');}p.push('>'+s+'</a>');l=l.substring(r+q.length);}l&&p.push(m(l));return p.join('');}e.exports=k;});
__d("MercuryLiveListenMessageRenderer",["css","DOM","Env","JSLogger","MercuryConstants"],function(a,b,c,d,e,f){var g=b('css'),h=b('DOM'),i=b('Env'),j=b('JSLogger'),k=c('MercuryConstants'),l=k.MusicLiveListenCommands,m=j.create('live_listen_renderer');function n(u,v){return h.$N('a',{href:u},v);}function o(u){var v=u.actor;if(v.id==i.user){return h.tx._("You are now listening to music with {name}.",{name:n(v.leader_profile_url,v.leader_name)});}else if(v.leader_id==i.user)return h.tx._("{name} is listening to music with you.",{name:n(v.url,v.name)});}function p(u){var v=u.actor,w=n(v.url,v.name),x=n(v.leader_profile_url,v.leader_name),y=v.action===l.LISTENER_ADD,z=i.user==v.id,aa=i.user==v.leader_id;if(y){if(z){return h.tx._("You are now listening to music with {name}.",{name:x});}else return h.tx._("{name} started listening.",{name:w});}else if(v.leader_id==v.id&&!aa){return h.tx._("{name} left the conversation. You will no longer hear the songs they play.",{name:x});}else if(z&&v.id!=v.leader_id){return h.tx._("You are no longer listening to music with {name}.",{name:x});}else if(!z){return h.tx._("{name} stopped listening.",{name:w});}else return '';}function q(u){return h.$N('span',{},[h.$N('strong',{},u.title),h.$N('br'),u.body]);}function r(){var u=null;if(a.MusicLiveListen){var v=a.MusicLiveListen.getInstance().getCurrentSession();u=v&&v.provider_name;}return u||'Spotify';}function s(u){var v=r(),w=n(u.url,u.title);w.target='_blank';var x=n(u.artist_url,u.artist);return h.tx._("{title} by {artist} on {provider}",{title:w,artist:x,provider:v});}var t={getIconSpriteClass:function(u){var v=u.log_message_data;if(v)switch(v.music_type){case 'begin_session':return 'addActionIcon';case 'listener_update':if(v.actor)if(v.actor.action===l.LISTENER_ADD){return 'addActionIcon';}else return 'leaveActionIcon';break;case 'song':return 'songIcon';case 'play_error':return 'playErrorIcon';}m.error('bad_message',u);return null;},getLogMessageText:function(u){var v=u.log_message_data;if(v)switch(v.music_type){case 'begin_session':return o(v);case 'listener_update':return p(v);case 'song':return s(v);case 'play_error':return q(v);}m.error('bad_message',u);return '';}};e.exports=t;});
__d("MercuryMessageRenderer",["css","DOM","Emote","HTML","htmlHyperlink","MercuryLiveListenMessageRenderer","MercuryParticipants","tx","MercuryConstants"],function(a,b,c,d,e,f){var g=b('css'),h=b('DOM'),i=b('Emote'),j=b('HTML'),k=b('htmlHyperlink'),l=b('MercuryLiveListenMessageRenderer'),m=b('MercuryParticipants'),n=c('MercuryConstants'),o=b('tx'),p={renderLogMessage:function(ca,da,ea){q(ca,ea);r(da,ea);},formatMessageBody:function(ca){ca=(ca||'').replace(/\n+$/,'');ca=k(ca,i.htmlEmote,null,true);return j(ca);}};function q(ca,da){var ea='';switch(da.log_message_type){case n.MercuryLogMessageType.SUBSCRIBE:ea='MercurySubscribeIcon';break;case n.MercuryLogMessageType.UNSUBSCRIBE:ea='MercuryUnsubscribeIcon';break;case n.MercuryLogMessageType.THREAD_NAME:ea='MercuryThreadNameIcon';break;case n.MercuryLogMessageType.THREAD_IMAGE:ea='MercuryThreadImageIcon';break;case n.MercuryLogMessageType.VIDEO_CALL:var fa=da.log_message_data.answered;if(fa||ba(da)){ea='MercuryVideoCallIcon';}else ea='MercuryMissedVideoCallIcon';break;case n.MercuryLogMessageType.SERVER_ERROR:ea='MercuryErrorIcon';break;case n.MercuryLogMessageType.LIVE_LISTEN:ea=l.getIconSpriteClass(da);break;}g.addClass(ca,ea);}function r(ca,da){switch(da.log_message_type){case n.MercuryLogMessageType.SUBSCRIBE:y(ca,da);break;case n.MercuryLogMessageType.UNSUBSCRIBE:z(ca,da);break;case n.MercuryLogMessageType.VIDEO_CALL:if(ba(da)){s(ca,da);}else t(ca,da);break;case n.MercuryLogMessageType.THREAD_NAME:u(ca,da);break;case n.MercuryLogMessageType.THREAD_IMAGE:v(ca,da);break;case n.MercuryLogMessageType.SERVER_ERROR:aa(ca,da);break;case n.MercuryLogMessageType.LIVE_LISTEN:var ea=l.getLogMessageText(da);if(ea)h.setContent(ca,ea);break;}}var s=function(ca,da){m.get(da.author,function(ea){var fa=ea.short_name,ga;switch(da.log_message_data.event_name){case 'installing':ga=h.tx._("{firstname} is setting up video calling...",{firstname:fa});break;case 'installed':ga=h.tx._("{firstname} finished setting up video calling.",{firstname:fa});break;case 'install_canceled':ga=h.tx._("You canceled the video calling installation. ",{firstname:fa});break;}if(ga)h.setContent(ca,ga);});},t=function(ca,da){var ea=da.log_message_data.caller,fa=da.log_message_data.callee,ga=[ea,fa];m.getMulti(ga,function(ha){if(ea==m.user){var ia=ha[fa].short_name;if(da.log_message_data.answered){message_text=h.tx._("You called {firstname}.",{firstname:ia});}else message_text=h.tx._("{firstname} missed a call from you. ",{firstname:ia});}else{var ja=ha[ea].short_name;if(da.log_message_data.answered){message_text=h.tx._("{firstname} called you.",{firstname:ja});}else message_text=h.tx._("You missed a call from {firstname}. ",{firstname:ja});}h.setContent(ca,message_text);});},u=function(ca,da){var ea=da.log_message_data.name,fa=h.$N('b',{},ea);if(da.author==m.user){if(ea){h.setContent(ca,h.tx._("You named the conversation: {name}.",{name:fa}));}else h.setContent(ca,h.tx._("You removed the conversation name."));}else m.get(da.author,function(ga){var ha,ia=w(ga);if(ea){ha=h.tx._("{actor} named the conversation: {name}.",{actor:ia,name:fa});}else ha=h.tx._("{actor} removed the conversation name.",{actor:ia});h.setContent(ca,ha);});},v=function(ca,da){if(da.author==m.user){if(da.log_message_data.image){h.setContent(ca,h.tx._("You changed the conversation picture."));}else h.setContent(ca,h.tx._("You removed the conversation picture."));}else m.get(da.author,function(ea){var fa=w(ea),ga;if(da.log_message_data.image){ga=h.tx._("{actor} changed the conversation picture.",{actor:fa});}else ga=h.tx._("{actor} removed the conversation picture.",{actor:fa});h.setContent(ca,ga);});},w=function(ca){if(ca.href)return h.$N('a',{href:ca.href},ca.name);return ca.name;},x=function(ca){if(ca.href)return h.$N('a',{href:ca.href},ca.short_name);return ca.short_name;},y=function(ca,da){var ea=da.log_message_data.added_participants,fa=null,ga;if(ea.length==1){fa=[da.author,ea[0]];m.getMulti(fa,function(ha){if(da.author==m.user){ga=h.tx._("You added {subscriber1}.",{subscriber1:w(ha[ea[0]])});}else ga=h.tx._("{actor} added {subscriber1}.",{actor:w(ha[da.author]),subscriber1:w(ha[ea[0]])});h.setContent(ca,ga);});}else if(ea.length==2){fa=[da.author].concat(ea.slice(0,2));m.getMulti(fa,function(ha){if(da.author==m.user){ga=h.tx._("You added {subscriber1} and {subscriber2}.",{subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]])});}else ga=h.tx._("{actor} added {subscriber1} and {subscriber2}.",{actor:w(ha[da.author]),subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]])});h.setContent(ca,ga);});}else{fa=[da.author].concat(ea.slice(0,2));m.getMulti(fa,function(ha){if(da.author==m.user){ga=h.tx._("You added {subscriber1}, {subscriber2} and {more_people}.",{subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]]),more_people:ea.length-2});}else ga=h.tx._("{actor} added {subscriber1}, {subscriber2} and {more_people}.",{actor:w(ha[da.author]),subscriber1:w(ha[ea[0]]),subscriber2:w(ha[ea[1]]),more_people:ea.length-2});h.setContent(ca,ga);});}},z=function(ca,da){m.get(da.author,function(ea){h.setContent(ca,h.tx._("{actor} left the conversation.",{actor:w(ea)}));});},aa=function(ca,da){var ea="We were unable to fetch previous messages in this conversation.";h.setContent(ca,ea);},ba=function(ca){return ca.log_message_data.event_name==='installing'||ca.log_message_data.event_name==='install_canceled';};e.exports=p;});
__d("MercuryMessages",["Arbiter","copyProperties","Env","JSLogger","math-extensions","ObjectUtils","tx","KeyedCallbackManager","PresenceUtil","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryParticipants","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('Env'),j=b('JSLogger'),k=b('math-extensions'),l=b('ObjectUtils'),m=b('tx'),n=b('KeyedCallbackManager'),o=b('PresenceUtil'),p=b('MercuryServerRequests'),q=b('MercuryThreadInformer'),r=b('MercuryThreads'),s=b('MercuryParticipants'),t=c('MercuryConstants'),u={},v={},w={},x={},y=function(ha){var ia=ha;if(v[ha])ia=v[ha];return u[ia];},z=new n();function aa(ha){return z.getResource(ha);}function ba(ha){ha.message_id=ha.message_id||ga.generateNewClientMessageID(ha.timestamp);var ia=s.user;ha.specific_to_list=ha.specific_to_list||[];if(ha.specific_to_list.length&&ha.specific_to_list.indexOf(ia)===-1)ha.specific_to_list.push(ia);if(!ha.thread_id){if(ha.specific_to_list.length==1){ha.thread_id='user:'+i.user;}else if(ha.specific_to_list.length==2){var ja=ha.specific_to_list[0]==ia?ha.specific_to_list[1]:ha.specific_to_list[0],ka=ja.indexOf(':');if(ja.substr(0,ka)=='fbid')ha.thread_id='user:'+ja.substr(ka+1);}ha.thread_id=ha.thread_id||'root:'+ha.message_id;}if(!ha.specific_to_list.length){var la=p.tokenizeThreadID(ha.thread_id);if(la.type=='user')ha.specific_to_list=['fbid:'+la.value,ia];}}function ca(ha,ia,ja){var ka=(new Date()).getTime(),la={action_type:ha,thread_id:ja,author:s.user,timestamp:ka,timestamp_absolute:(new Date(ka)).toLocaleString(),timestamp_relative:"a few seconds ago",is_unread:false,is_cleared:false,source:ia};return la;}function da(ha){switch(ha){case t.MercuryPayloadSource.UNKNOWN:case t.MercuryPayloadSource.SERVER_INITIAL_DATA:case t.MercuryPayloadSource.SERVER_FETCH_THREAD_INFO:case t.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;}return false;}function ea(ha){return ha&&ha.substr(0,6)==='server';}g.subscribe(j.DUMP_EVENT,function(ha,ia){var ja={};for(var ka in u){var la=u[ka],ma=la.thread_id;ja[ma]=ja[ma]||{};ja[ma][la.message_id]=h({},la);}ia.messaging=ia.messaging||{};ia.messaging.local_message_ids=h({},v);ia.messaging.messages=ja;});function fa(ha){ha.forEach(function(ia){x[ia]=true;if(z.getResource(ia)===undefined)z.setResource(ia,[]);});}var ga={getThreadMessageIDs:function(ha,ia,ja){var ka=z.executeOrEnqueue(ha,ja),la=w[ha];if(!x[ha]&&(ka.length||z.getResource(ha).length<ia)&&!la){p.fetchThreadMessages(ha,ia);}else w[ha]=false;},getThreadMessages:function(ha,ia,ja){this.getThreadMessageIDs(ha,ia,function(ka){var la=ka.map(y);ja(la);});},handleUpdates:function(ha,ia){var ja={},ka={},la=t.MercuryActionStatus;for(var ma=0;ma<ha.length;ma++){var na=ha[ma],oa=na.action_type;if(oa==t.MercuryActionType.SEND_MESSAGE){var pa=na.client_message_id;if(pa&&v[pa]&&na.status){if(na.status==la.UNCONFIRMED){if(!ka[na.thread_id])ka[na.thread_id]=[];ka[na.thread_id].push(na.client_message_id);}else if(!ja[na.thread_id])ja[na.thread_id]=[];var qa=y(na.client_message_id),ra=qa.status;qa.status=na.status;if(na.status==la.SUCCESS)this.updateLocalMessage(na);if(typeof ra!='undefined'||na.status==la.REQUEST_ERROR||na.status==la.FAILED_UNKNOWN_REASON||na.status==la.UNABLE_TO_CONFIRM||na.status==la.RESENT)q.reorderedMessages(na.thread_id);}continue;}else if(oa==t.MercuryActionType.USER_GENERATED_MESSAGE){if(na.status==la.RESENDING)q.reorderedMessages(na.thread_id);}else if(oa==t.MercuryActionType.DELETE_THREAD){z.setResource(na.thread_id,[]);continue;}else if(oa==t.MercuryActionType.LOG_MESSAGE){if(na.log_message_type==t.MercuryLogMessageType.SERVER_ERROR)w[na.thread_id]=true;}else if(oa==t.MercuryActionType.CLEAR_CHAT){var sa=z.getResource(na.thread_id)||[];sa.map(y).forEach(function(wa){wa.is_cleared=true;});continue;}if((na.threading_id&&v[na.threading_id])||y(na.message_id))continue;if(!ja[na.thread_id])ja[na.thread_id]=[];ja[na.thread_id].push(na.message_id);u[na.message_id]=na;q.receivedMessage(na);}for(var ta in ja){var ua=z.getResource(ta)||[];ua=ua.filter(function(wa){var xa=u[wa];return xa.action_type!=t.MercuryActionType.LOG_MESSAGE||xa.log_message_type!=t.MercuryLogMessageType.SERVER_ERROR;});ua=ua.concat(ja[ta]);if(ia){ua.sort(function(wa,xa){var ya=y(wa),za=y(xa);return (ya.timestamp-za.timestamp);});q.reorderedMessages(ta);}z.setResource(ta,ua);q.updatedThread(ta);}var va=l.getKeys(ka);if(va.length)p.requestMessageConfirmation(ka);},sendMessage:function(ha){ba(ha);v[ha.message_id]=ha.message_id;q.synchronizeInforms(function(){this.handleUpdates([ha],false);p.sendNewMessage(ha);}.bind(this));return ha.thread_id;},resendMessage:function(ha){var ia=h({},ha);ia.status=t.MercuryActionStatus.RESENDING;ia.timestamp=(new Date()).getTime();ia.message_id=ga.generateNewClientMessageID(ia.timestamp);y(ha.message_id).status=t.MercuryActionStatus.RESENT;this.sendMessage(ia);},updateLocalMessage:function(ha){var ia=ha.message_id,ja=ha.client_message_id;v[ja]=ia;u[ia]=u[ja];u[ja]={};if(ha.timestamp)y(ja).timestamp=ha.timestamp;},constructUserGeneratedMessageObject:function(ha,ia,ja,ka){var la=ca(t.MercuryActionType.USER_GENERATED_MESSAGE,ia,ja);la.body=ha;la.has_attachment=false;la.is_html=false;la.attachments=[];la.specific_to_list=ka||[];return la;},constructLogMessageObject:function(ha,ia,ja,ka){var la=ca(t.MercuryActionType.LOG_MESSAGE,ha,ia);la.log_message_type=ja;la.log_message_data=ka;return la;},generateNewClientMessageID:function(ha){var ia=ha+':'+(k.rand32()+1)+'-'+o.getSessionID();return '<'+ia+'@mail.projektitan.com>';}};p.subscribe('update-messages',function(ha,ia){if(ia.end_of_history)fa(ia.end_of_history);if(!ia.actions||!ia.actions.length)return;var ja=ia.actions.filter(function(la){var ma=la.action_type;return la.thread_id&&(ma==t.MercuryActionType.LOG_MESSAGE||ma==t.MercuryActionType.USER_GENERATED_MESSAGE||ma==t.MercuryActionType.SEND_MESSAGE||ma==t.MercuryActionType.CLEAR_CHAT||ma==t.MercuryActionType.DELETE_THREAD);}),ka=da(ia.payload_source);if(ea(ia.payload_source))ja.forEach(function(la){var ma=r.getThreadMetaNow(la.thread_id);if(ma)la.is_cleared=la.timestamp<ma.chat_clear_time;});ga.handleUpdates(ja,ka);});e.exports=ga;});
__d("ChatTabMessagesView",["Arbiter","ArbiterMixin","AvailableList","AvailableListConstants","ChannelConstants","ChatVisibility","ChatConfig","css","DOM","Emote","Env","MercuryMessageRenderer","MercuryAttachment","MercuryMessages","MercuryThreadMetadataRenderer","MercuryThreads","MercuryParticipants","MercuryThreadInformer","Tooltip","VideoCallCore","copyProperties","isRTL","tx","ChatTabTemplates","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('ChannelConstants'),l=b('ChatVisibility'),m=b('ChatConfig'),n=b('css'),o=b('DOM'),p=b('Emote'),q=b('Env'),r=b('MercuryMessageRenderer'),s=b('MercuryAttachment'),t=b('MercuryMessages'),u=b('MercuryThreadMetadataRenderer'),v=b('MercuryThreads'),w=b('MercuryParticipants'),x=b('MercuryThreadInformer'),y=b('Tooltip'),z=b('VideoCallCore'),aa=c('ChatTabTemplates'),ba=c('MercuryConstants'),ca=b('copyProperties'),da=b('isRTL'),ea=b('tx');function fa(wa){var xa=aa[':fb:chat:conversation:message-group'].build();xa.setNodeContent('timestamp',na.renderAbsoluteTimestamp(wa.timestamp));w.get(wa.author,function(ya){var za=xa.getNode('profileLink');za.href=ya.href;var ab=ya.fbid==q.user?"You":ya.name;y.set(za,ab,'left');xa.setNodeProperty('profilePhoto','src',ya.image_src);});return xa;}function ga(wa){var xa=aa[':fb:chat:conversation:message:event'].build();xa.setNodeContent('timestamp',na.renderAbsoluteTimestamp(wa.timestamp));r.renderLogMessage(xa.getNode('icon'),xa.getNode('message'),wa);var ya=ha(wa);if(ya)o.appendContent(xa.getNode('message'),ya);return xa.getRoot();}function ha(wa){var xa,ya;if(wa.log_message_type==ba.MercuryLogMessageType.VIDEO_CALL)if(wa.log_message_data.event_name=='install_canceled'){xa=o.tx._("Retry setup and call back.");ya='callback_cancelinstall_link';return ia(xa,wa.thread_id,wa.log_message_data.to,ya);}else if(!wa.log_message_data.event_name&&wa.log_message_data.callee==w.user&&!wa.log_message_data.answered){xa=o.tx._("Call Back");ya='callback_link';return ia(xa,wa.thread_id,wa.log_message_data.caller.split(':')[1],ya);}return null;}function ia(wa,xa,ya,za){if(z.isSupported()){var ab=i.get(ya),bb=!(l.isOnline()&&(ab==j.ACTIVE||ab==j.IDLE)),cb=o.$N('a',{href:'#',className:'callBackLink'},wa);if(bb)n.hide(cb);cb.setAttribute('data-gt',JSON.stringify({videochat:'clicked_callback_link'}));Event.listen(cb,'click',function(){na.inform('video-call-clicked',{userID:ya,threadID:xa,clickSource:za});});return cb;}return null;}function ja(wa){var xa=aa[':fb:mercury:chat:message:forward'].build(),ya=xa.getNode('forwardText');if(ya){n.hide(xa.getRoot());u.renderTitanLink(wa.thread_id,xa.getNode('forwardLink'),n.show.bind(n,xa.getRoot()));if(wa.forward_count>1){o.appendContent(ya,ea._("{count} forwarded messages",{count:wa.forward_count}));}else o.appendContent(ya,"1 forwarded message");}return xa.getRoot();}var ka=["January","February","March","April","May","June","July","August","September","October","November","December"];function la(wa){var xa=new Date();xa.setHours(0);xa.setMinutes(0);xa.setSeconds(0);xa.setMilliseconds(0);var ya=24*60*60*1000,za=xa.getTime()-wa.getTime();if(za<=0){return "Today";}else if(za<ya)return "Yesterday";return ea._("{month} {date}",{month:ka[wa.getMonth()],date:wa.getDate()});}var ma=[];function na(wa,xa,ya){this.threadID=wa;this.scrollContainer=xa;this.conversationElem=ya;this.messageGroup=null;this.prevMessage=null;ma.push(this);this._subscription=g.subscribe('overflow-applied-to-body',this.scrollToBottom.bind(this));this.rerender();}na.renderAbsoluteTimestamp=function(wa){var xa=new Date(wa),ya=xa.getHours(),za=xa.getMinutes(),ab='';if(!m.get('24h_times')){ab='am';if(ya>=12){ab='pm';ya-=12;}if(ya===0)ya=12;}else if(ya<10)ya='0'+ya;if(za<10)za='0'+za;return ya+':'+za+ab;};function oa(wa){var xa=aa[':fb:mercury:attachment:error'].build().getRoot();o.appendContent(xa,wa.error_msg);return xa;}function pa(wa){var xa=aa[':fb:mercury:attachment:file-link'].build().setNodeContent('filename',wa.name),ya=xa.getNode('link');ya.setAttribute('href',wa.url);wa.rel&&ya.setAttribute('rel',wa.rel);n.addClass(xa.getRoot(),s.getAttachIconClass(wa.icon_type));return xa.getRoot();}function qa(wa){var xa=aa[':fb:mercury:attachment:music'].build().setNodeContent('filename',wa.name),ya=xa.getNode('link');ya.setAttribute('href',wa.url);ya.setAttribute('target','_blank');wa.rel&&ya.setAttribute('rel',wa.rel);var za=xa.getNode('preview-link');za.setAttribute('href',wa.url);wa.rel&&za.setAttribute('rel',wa.rel);xa.getNode('preview-image').setAttribute('src',wa.preview_url);n.addClass(xa.getNode('icon_link'),'MercuryMusicIcon');return xa;}function ra(wa){var xa=aa[':fb:mercury:attachment:share-link'].build().setNodeContent('name',wa.name),ya=xa.getNode('link');ya.setAttribute('href',wa.url);wa.rel&&ya.setAttribute('rel',wa.rel);return xa;}function sa(wa){var xa=aa[':fb:mercury:attachment:external-link'].build().setNodeContent('name',wa.name).setNodeContent('shortLink',wa.base_url),ya=xa.getNode('preview-link');ya.setAttribute('href',wa.url);wa.rel&&ya.setAttribute('rel',wa.rel);xa.getNode('preview-image').setAttribute('src',wa.preview_url);xa.getNode('name').setAttribute('href',wa.url);n.addClass(xa.getNode('preview'),wa.preview_class);return xa;}function ta(wa){var xa=aa[':fb:mercury:attachment:preview'].build(),ya=xa.getNode('preview-link');ya.setAttribute('href',wa.url);wa.rel&&ya.setAttribute('rel',wa.rel);xa.getNode('preview-image').setAttribute('src',wa.preview_url);n.addClass(xa.getRoot(),wa.preview_class);return xa;}function ua(wa){var xa=aa[':fb:mercury:attachment:video-thumb'].build(),ya=xa.getNode('thumb');ya.setAttribute('href',wa.url);ya.setAttribute('rel',wa.rel);var za=o.find(xa.getRoot(),'img');za.src=wa.preview_url;return xa;}Function.mixin(na,h);ca(na.prototype,{destroy:function(){o.empty(this.conversationElem);g.unsubscribe(this._subscription);ma.remove(this);},appendMessage:function(wa){if(wa==this.prevMessage)return;var xa=ba.MercuryThreadlistConstants,ya=v.getThreadMetaNow(this.threadID),za=xa.MESSAGE_TIMESTAMP_THRESHOLD,ab=xa.GROUPING_THRESHOLD,bb=wa.action_type==ba.MercuryActionType.LOG_MESSAGE&&wa.log_message_type==ba.MercuryLogMessageType.SERVER_ERROR;if(wa.status==ba.MercuryActionStatus.RESENT)return;if(wa.is_cleared)return;if(wa.timestamp<(new Date()).getTime()-za&&!bb)return;var cb=null;if(this.prevMessage)cb=new Date(this.prevMessage.timestamp);var db=new Date(wa.timestamp);if(!bb&&(!cb||cb.getDate()!=db.getDate()||cb.getMonth()!=db.getMonth()||cb.getFullYear()!=db.getFullYear())){var eb=aa[':fb:chat:conversation:date-break'].build();o.setContent(eb.getRoot(),la(db));o.appendContent(this.conversationElem,eb.getRoot());this.messageGroup=null;}if(wa.action_type==ba.MercuryActionType.LOG_MESSAGE){o.appendContent(this.conversationElem,ga(wa));this.messageGroup=null;this.prevMessage=wa;return;}if(!this.messageGroup||this.prevMessage.author!=wa.author||this.prevMessage.timestamp<wa.timestamp-ab){this.messageGroup=fa(wa);o.appendContent(this.conversationElem,this.messageGroup.getRoot());}var fb=this._renderSingleMessage(wa);o.appendContent(this.messageGroup.getNode('messages'),fb);this.prevMessage=wa;},rerender:function(){o.empty(this.conversationElem);this.messageGroup=null;this.prevMessage=null;t.getThreadMessages(this.threadID,ba.MercuryThreadlistConstants.RECENT_MESSAGES_LIMIT,function(wa){wa.forEach(this.appendMessage.bind(this));this.scrollToBottom();}.bind(this));},scrollToBottom:function(){this.scrollContainer.scrollTop=this.scrollContainer.scrollHeight;},_renderSingleMessage:function(wa){var xa=aa[':fb:chat:conversation:message'].render();if(wa.subject){var ya=aa[':fb:chat:conversation:message:subject'].render();o.setContent(ya,wa.subject);o.appendContent(xa,ya);}if(wa.body.substr(0,4)=='?OTR'){o.setContent(xa,"[encrypted message]");n.addClass(xa,'cyphertext');}else{n.addClass(xa,da(wa.body)?'direction_rtl':'direction_ltr');o.appendContent(xa,r.formatMessageBody(wa.body));}if(wa.has_attachment)this._appendMessageAttachments(xa,wa.attachments);if(wa.forward_count)o.appendContent(xa,ja(wa));if(wa.status!==undefined&&wa.status!=ba.MercuryActionStatus.SUCCESS&&wa.status!=ba.MercuryActionStatus.UNCONFIRMED){var za=u.renderStatusIndicator(wa.status,t.resendMessage.bind(t,wa));n.addClass(xa,'errorStatus');var ab=aa[':fb:chat:conversation:message:status'].build();o.appendContent(ab.getNode('message'),xa);o.appendContent(ab.getNode('status'),za);return ab.getRoot();}return xa;},_appendMessageAttachments:function(wa,xa){var ya=ba.MercuryAttachmentType;for(var za=0,ab=xa.length;za<ab;++za){var bb=xa[za],cb=bb.attach_type,db=bb.share_data_type;if(cb==ya.ERROR)o.appendContent(wa,oa(bb));if(cb==ya.FILE)o.appendContent(wa,pa(bb));var eb=null,fb;if(cb==ya.SHARE&&db==ba.MercurySupportedShareType.FB_VIDEO){eb=ua(bb);fb=o.find(eb.getRoot(),'img');Event.listen(fb,'load',this._thumbLoaded.shield(this,fb));}else if(cb==ya.SHARE&&(db==ba.MercurySupportedShareType.FB_MUSIC_ALBUM||db==ba.MercurySupportedShareType.FB_SONG)){eb=qa(bb);fb=o.find(eb.getRoot(),'img');Event.listen(fb,'load',this._thumbLoaded.shield(this,fb));}else if(cb==ya.SHARE&&(db==ba.MercurySupportedShareType.EXTERNAL||db==ba.MercurySupportedShareType.FB_TEMPLATE)){eb=sa(bb);fb=o.find(eb.getRoot(),'img');Event.listen(fb,'load',this._thumbLoaded.shield(this,fb));}else if(bb.preview_url){eb=ta(bb);fb=eb.getNode('preview-image');Event.listen(fb,'load',this._thumbLoaded.shield(this,fb));}else if(cb==ya.SHARE)eb=ra(bb);if(eb)o.appendContent(wa,eb.getRoot());}},_thumbLoaded:function(wa){var xa=this.scrollContainer.scrollTop+this.scrollContainer.clientHeight;if(xa+wa.offsetHeight>=this.scrollContainer.scrollHeight)this.scrollToBottom();}});x.subscribe('messages-reordered',function(wa,xa){ma.forEach(function(ya){xa[ya.threadID]&&ya.rerender();});});x.subscribe('messages-received',function(wa,xa){ma.forEach(function(ya){var za=xa[ya.threadID];if(za){za.forEach(ya.appendMessage.bind(ya));ya.scrollToBottom();}});});g.subscribe(k.getArbiterType('chat_event'),function(wa,xa){if(va(xa.obj)){var ya=(q.user==xa.obj.from)?xa.obj.to:xa.obj.from,za=v.getThreadIdForUser(ya),ab=ma.filter(function(db){return db.threadID===za;});if(ab.length>0){var bb=ab[0],cb=t.constructLogMessageObject(ba.MercurySourceType.CHAT_WEB,za,ba.MercuryLogMessageType.VIDEO_CALL,xa.obj);cb.author='fbid:'+xa.obj.from;bb.appendMessage(cb);bb.scrollToBottom();}}});function va(wa){return (wa.event_name==='installing'||wa.event_name==='install_canceled');}e.exports=na;});
__d("ChatTabSheetPolicy",[],function(a,b,c,d,e,f){var g={canReplaceOpenSheet:function(h,i){if(h.getType()==i.getType())return false;if(h.isPermanent()&&!i.isPermanent())return false;return true;}};e.exports=g;});
__d("MercuryTypeahead",["Bootloader","DOM","Env","Input","copyProperties","MercuryDataSource","MercuryTypeaheadTemplates"],function(a,b,c,d,e,f){var g=b('Bootloader'),h=b('DOM'),i=b('Env'),j=b('Input'),k=b('copyProperties'),l=c('MercuryDataSource'),m=c('MercuryTypeaheadTemplates'),n=function(){this._domElement=null;this._typeahead=null;this._tokenizer=null;this._placeholder='';this._exclusions=[];};k(n.prototype,{setPlaceholder:function(o){this._placeholder=o;return this;},setExcludedParticipants:function(o){this._exclusions=[];o.forEach(function(p){var q=p.indexOf(':');if(p.substr(0,q)=='fbid')this._exclusions.push(p.substr(q+1));}.bind(this));return this;},build:function(o){if(this._domElement){o(this._domElement);return;}g.loadModules(['Typeahead','ContextualTypeaheadView','TypeaheadCore','Tokenizer'],function(p,q,r,s){var t=m[':fb:mercury:tokenizer'].build(),u=m[':fb:mercury:typeahead'].build();this._domElement=t.getRoot();h.appendContent(this._domElement,u.getRoot());var v=u.getNode('textfield');j.setPlaceholder(v,this._placeholder);v.setAttribute('data-placeholder',this._placeholder);var w={ctor:'ContextualTypeaheadView',options:{renderer:'compact',autoSelect:true}},x={ctor:'TypeaheadCore',options:{setValueOnSelect:true}};this._typeahead=new p(l,w,x,u.getRoot());this._typeahead.init();var y={inline:true};this._tokenizer=new s(this._domElement,this._typeahead);this._tokenizer.init(t.getNode('tokenarea'),'participants',[],y);Event.listen(v,'focus',function(){this._resetDataSource();this._typeahead.init();}.bind(this));Event.listen(this._domElement,'click',this.focus.bind(this));o(this._domElement);}.bind(this));},getSelectedParticipantIDs:function(){var o=[];if(this._tokenizer)(this._tokenizer.getTokenValues()||[]).forEach(function(p){o.push('fbid:'+p);});return o;},reset:function(){this._tokenizer&&this._tokenizer.reset();},focus:function(){this._tokenizer&&this._tokenizer.focusInput();},_resetDataSource:function(){l.setExclusions(this._exclusions);}});e.exports=n;});
__d("ChatTabSheetView",["event-extensions","Animation","Arbiter","ChatTabSheetPolicy","css","DOM","Vector","copyProperties","MercuryTypeahead","MercuryMessages","MercuryServerRequests","MercuryConstants","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Animation'),h=b('Arbiter'),i=b('ChatTabSheetPolicy'),j=b('css'),k=b('DOM'),l=b('Vector'),m=b('copyProperties'),n=b('MercuryTypeahead'),o=b('MercuryMessages'),p=b('MercuryServerRequests'),q=c('MercuryConstants'),r=c('ChatTabTemplates'),s=5000,t=function(u,v,w){this._threadID=u;this._rootElement=v;this._tabMainElement=w;this._openSheet=null;};m(t.prototype,{destroy:function(){k.empty(this._rootElement);},_openCommon:function(u,v){if(this._openSheet&&!i.canReplaceOpenSheet(this._openSheet,u))return;this.clear(function(){this._openSheet=u;var w=r[':fb:mercury:chat:tab-sheet:loading'].build().getRoot();k.setContent(this._rootElement,w);j.show(w);j.show(this._rootElement);u.render();if(v){j.addClass(this._tabMainElement,'sheetSlide');var x=l.getElementDimensions(this._rootElement).y;j.setStyle(this._rootElement,'bottom',x+'px');this._animation=new g(this._rootElement).to('bottom',0).duration(150).ease(g.ease.both).ondone(function(){j.removeClass(this._tabMainElement,'sheetSlide');}.bind(this)).go();}if(!u.isPermanent()){var y=s;if(u.getCloseTimeout)y=u.getCloseTimeout();this._sheetCloseHandler=this.close.bind(this,u).defer(y,false);}}.bind(this));},set:function(u){return this._openCommon(u,false);},open:function(u){return this._openCommon(u,true);},close:function(u,v){if(this._openSheet!=u)return;if(!this._openSheet){v&&v();return;}if(this._animation)this._animation.stop();if(this._sheetCloseHandler){clearTimeout(this._sheetCloseHandler);this._sheetCloseHandler=null;}j.addClass(this._tabMainElement,'sheetSlide');var w=l.getElementDimensions(this._rootElement).y;this._animation=new g(this._rootElement).to('bottom',w+'px').duration(100).ease(g.ease.begin).ondone(function(){k.empty(this._rootElement);j.hide(this._rootElement);j.removeClass(this._tabMainElement,'sheetSlide');this._openSheet=null;v&&v();}.bind(this)).go();},clear:function(u){this.close(this._openSheet,u);}});e.exports=t;});
__d("ChatAddFriendsTabSheet",["Arbiter","ChatTabSheetView","copyProperties","DOM","MercuryTypeahead","MercuryMessages","MercuryServerRequests","MercuryThreads","tx","MercuryConstants","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatTabSheetView'),i=b('copyProperties'),j=b('DOM'),k=b('MercuryTypeahead'),l=b('MercuryMessages'),m=b('MercuryServerRequests'),n=b('MercuryThreads'),o=c('MercuryConstants'),p=c('ChatTabTemplates'),q=b('tx');function r(u,v,w){this._threadID=u;this._rootElement=v;this._sheetView=w;}i(r.prototype,{render:function(){var u=p[':fb:mercury:chat:tab-sheet:add-friends'].build();n.getThreadMeta(this._threadID,function(v){var w=new k();w.setExcludedParticipants(v.participants);w.setPlaceholder("Enter a friend's name");w.build(function(z){j.replace(u.getNode('participantsTypeahead'),z);j.setContent(this._rootElement,u.getRoot());w.focus();}.bind(this));var x=v.participants,y=v.is_canonical_user?s.bind(null,this,this._sheetView,x,w):t.bind(null,this,this._sheetView,this._threadID,w);Event.listen(u.getNode('doneButton'),'click',y);}.bind(this));},isPermanent:function(){return true;},getType:function(){return 'add_friends_type';},open:function(){this._sheetView.open(this);}});function s(u,v,w,x){var y=x.getSelectedParticipantIDs();if(y.length){var z='root:'+l.generateNewClientMessageID((new Date()).getTime());n.createNewLocalThread(z,w.concat(y));g.inform('chat/open-tab',{thread_id:z});}v.close(u);}function t(u,v,w,x){var y=x.getSelectedParticipantIDs();if(y.length)if(n.isEmptyLocalThread(w)){n.addParticipantsToThreadLocally(w,y);}else l.sendMessage(l.constructLogMessageObject(o.MercurySourceType.CHAT_WEB,w,o.MercuryLogMessageType.SUBSCRIBE,{added_participants:y}));v.close(u);}e.exports=r;});
__d("ChatAvailabilityTabSheet",["Arbiter","AvailableListConstants","AvailableList","ChatConfig","css","DOM","FunctionUtils","GenderConst","MercuryThreads","ShortProfiles","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableListConstants'),i=b('AvailableList'),j=b('ChatConfig'),k=b('css'),l=b('DOM'),m=b('FunctionUtils'),n=b('GenderConst'),o=b('MercuryThreads'),p=b('ShortProfiles'),q=b('copyProperties'),r=c('ChatTabTemplates');function s(w,x,y,z){this._handledAvailability=x;this._sheetView=z;this._rootElement=y;this._canonicalUser=o.getCanonicalUserInThread(w);if(this._canonicalUser){this._currentAvailability=h.ACTIVE;this._handleAvailabilityChange();g.subscribe(h.ON_AVAILABILITY_CHANGED,this._handleAvailabilityChange.bind(this));}}s.createSheets=function(w,x,y){var z={};[h.ACTIVE,h.OFFLINE,h.MOBILE].forEach(function(aa){z[aa]=new s(w,aa,x,y);});return z;};q(s.prototype,{render:function(){!this._canonicalUser;var w=r[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();p.get(this._canonicalUser,function(x){var y=null;switch(this._currentAvailability){case h.ACTIVE:k.addClass(w.getRoot(),'active');y=t(x);break;case h.MOBILE:k.addClass(w.getRoot(),'mobile');y=u(x);break;case h.OFFLINE:y=v(x);break;}l.setContent(w.getNode('text'),y);l.setContent(this._rootElement,w.getRoot());}.bind(this));},isPermanent:function(){return false;},getType:function(){switch(this._handledAvailability){case h.ACTIVE:return 'availability_active_type';case h.MOBILE:return 'availability_mobile_type';case h.OFFLINE:return 'availability_offline_type';default:throw new Error("Invalid handled availability");}},getCloseTimeout:function(){return 5000;},_handleAvailabilityChange:function(){var w=i.get(this._canonicalUser);if(w==this._currentAvailability)return;this._currentAvailability=w;if(w==this._handledAvailability)this._sheetView.open(this);}});function t(w){return l.tx._("{name} is now available.",{name:w.firstName});}function u(w){return l.tx._("Your messages will be sent to {name}'s phone.",{name:w.firstName});}function v(w){switch(w.gender){case n.FEMALE_SINGULAR:case n.FEMALE_SINGULAR_GUESS:return l.tx._("{name} is offline, but you can still send her a message.",{name:w.firstName});case n.MALE_SINGULAR:case n.MALE_SINGULAR_GUESS:return l.tx._("{name} is offline, but you can still send him a message.",{name:w.firstName});default:return l.tx._("{name} is offline, but you can still send them a message.",{name:w.firstName});}}e.exports=s;});
__d("ChatNoListenersTabSheet",["Arbiter","copyProperties","DOM","MusicConstants","MercuryAssert","MercuryIDs","MercuryParticipants","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('DOM'),j=b('MusicConstants'),k=b('MercuryAssert'),l=b('MercuryIDs'),m=b('MercuryParticipants'),n=c('ChatTabTemplates');function o(p,q,r){k.isThreadID(p);var s=l.tokenize(p);if(s.type!='live_listen')throw 'bad live_listen thread id';this._sessionID=s.value;this._rootElement=q;this._sheetView=r;a.MusicEvents.subscribe([j.LIVE_LISTEN_OP.END_SESSION],this._handleEndSession.bind(this),g.SUBSCRIBE_NEW);}h(o.prototype,{render:function(){var p=n[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();i.setContent(p.getNode('text'),i.tx._("There is no longer anyone listening with you."));i.setContent(this._rootElement,p.getRoot());},isPermanent:function(){return true;},getType:function(){return 'no_listeners_type';},_handleEndSession:function(p,q){if(q&&q.session&&q.session.session_id==this._sessionID)this._sheetView.open(this);}});e.exports=o;});
__d("ChatNoRecipientsTabSheet",["DOM","MercuryParticipants","MercuryThreadInformer","MercuryThreads","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('MercuryParticipants'),i=b('MercuryThreadInformer'),j=b('MercuryThreads'),k=b('copyProperties'),l=c('ChatTabTemplates');function m(n,o,p){this._threadID=n;this._rootElement=o;this._sheetView=p;i.subscribe('threads-updated',this._handleThreadsUpdated.bind(this));}k(m.prototype,{render:function(){var n=l[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();g.setContent(n.getNode('text'),g.tx._("All recipients have left this conversation. Please close the stale tab."));g.setContent(this._rootElement,n.getRoot());},isPermanent:function(){return true;},getType:function(){return 'no_recipients_type';},_handleThreadsUpdated:function(){j.getThreadMeta(this._threadID,function(n){var o=h.user,p=n.participants.filter(function(q){return q!=o;});if(p.length<1){this._sheetView.open(this);}else this._sheetView.close(this);}.bind(this));}});e.exports=m;});
__d("ChatOfflineTabSheet",["ChatPrivacyActionController","ChatTabSheetView","ChatVisibility","copyProperties","css","DOM","JSLogger","MercuryThreads","MercuryParticipants","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ChatPrivacyActionController'),h=b('ChatTabSheetView'),i=b('ChatVisibility'),j=b('copyProperties'),k=b('css'),l=b('DOM'),m=b('JSLogger'),n=b('MercuryThreads'),o=b('MercuryParticipants'),j=b('copyProperties'),p=c('ChatTabTemplates');function q(r,s,t){this._rootElement=s;this._sheetView=t;this._logger=m.create('blackbird');this._canonicalUser=n.getCanonicalUserInThread(r);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}j(q.prototype,{render:function(){if(!this._canonicalUser)this._logger.error('offline_sheet_open_with_non_friend');var r=p[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build(),s='fbid:'+this._canonicalUser;o.get(s,function(t){var u='fbChatGoOnlineLink',v=l.$N('a',{href:'#',className:u},l.tx._("go online")),w=l.tx._("You are now offline. To chat with {name} and other friends, {link}.",{name:t.short_name,link:v});l.setContent(r.getNode('text'),w);k.addClass(r.getRoot(),'chatOffline');l.setContent(this._rootElement,r.getRoot());Event.listen(this._rootElement,'click',function(event){if(k.hasClass(event.getTarget(),u)){if(i.isOnline())this._logger.error('tab_sheet_already_online');this._privacyActionController.togglePrivacy();this._logger.log('tab_sheet_go_online',{tab_id:this._canonicalUser});return false;}}.bind(this));}.bind(this));},_handlePrivacyChange:function(r){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(r){case g.OFFLINE:this._sheetView.open(this);break;case g.NORMAL:case g.BLOCKED:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'offline_type';}});e.exports=q;});
__d("ChatUserBlockedTabSheet",["ChatPrivacyActionController","ChatTabSheetView","copyProperties","css","DOM","GenderConst","JSLogger","MercuryThreads","MercuryParticipants","tx","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ChatPrivacyActionController'),h=b('ChatTabSheetView'),i=b('copyProperties'),j=b('css'),k=b('DOM'),l=b('GenderConst'),m=b('JSLogger'),n=b('MercuryThreads'),o=b('MercuryParticipants'),p=c('ChatTabTemplates'),q=b('tx');function r(s,t,u){this._rootElement=t;this._sheetView=u;this._logger=m.create('blackbird');this._canonicalUser=n.getCanonicalUserInThread(s);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}i(r.prototype,{render:function(){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_open_with_non_friend');var s=p[':fb:mercury:chat:tab-sheet:user-blocked'].build(),t='fbid:'+this._canonicalUser;o.get(t,function(u){var v=null;switch(u.gender){case l.FEMALE_SINGULAR:case l.FEMALE_SINGULAR_GUESS:v=q._("{name} sees you as offline on chat, but you can still send her a message. ",{name:u.short_name});break;case l.MALE_SINGULAR:case l.MALE_SINGULAR_GUESS:v=q._("{name} sees you as offline on chat, but you can still send him a message. ",{name:u.short_name});break;default:v=q._("{name} sees you as offline on chat, but you can still send them a message. ",{name:u.short_name});}k.setContent(s.getNode('text'),v);var w=q._("Go Online to {name}",{name:u.short_name});k.setContent(s.getNode('actionLink'),w);j.addClass(s.getRoot(),'blocked');k.setContent(this._rootElement,s.getRoot());Event.listen(s.getNode('actionLink'),'click',this._privacyActionController.togglePrivacy.bind(this._privacyActionController));}.bind(this));},_handlePrivacyChange:function(s){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(s){case g.BLOCKED:this._sheetView.open(this);break;case g.NORMAL:case g.OFFLINE:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'user_blocked_type';}});e.exports=r;});
__d("ChatTabSheetController",["ChatAddFriendsTabSheet","ChatAvailabilityTabSheet","ChatNoListenersTabSheet","ChatNoRecipientsTabSheet","ChatOfflineTabSheet","ChatTabSheetView","ChatUserBlockedTabSheet","copyProperties","MercuryServerRequests","MercuryThreads"],function(a,b,c,d,e,f){var g=b('ChatAddFriendsTabSheet'),h=b('ChatAvailabilityTabSheet'),i=b('ChatNoListenersTabSheet'),j=b('ChatNoRecipientsTabSheet'),k=b('ChatOfflineTabSheet'),l=b('ChatTabSheetView'),m=b('ChatUserBlockedTabSheet'),n=b('copyProperties'),o=b('MercuryServerRequests'),p=b('MercuryThreads'),q=function(r,s,t){this._sheetView=new l(r,s,t);this._addFriendsTabSheet=new g(r,s,this._sheetView);this._userBlockedTabSheet=new m(r,s,this._sheetView);this._offlineTabSheet=new k(r,s,this._sheetView);this._availabilityTabSheets=h.createSheets(r,s,this._sheetView);if(p.isMultichatThread(r)){this._noRecipientsTabSheet=new j(r,s,this._sheetView);}else if(p.isLiveListenThread(r))this._noListenersTabSheet=new i(r,s,this._sheetView);};n(q.prototype,{openAddFriendsSheet:function(){this._addFriendsTabSheet.open();},destroy:function(){this._sheetView.destroy();}});e.exports=q;});
__d("setTimeoutAcrossTransitions",[],function(a,b,c,d,e,f){function g(h,i){return setTimeout(h,i,false);}e.exports=g;});
__d("TypingDetector",["event-extensions","function-extensions","ArbiterMixin","Class","Input","ObjectUtils","Run"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('ArbiterMixin'),h=b('Class'),i=b('Input'),j=b('ObjectUtils'),k=b('Run');function l(m){this._input=m;this._ignoreKeys={};}l.INACTIVE=0;l.TYPING=1;l.QUITTING=2;h.mixin(l,g,{_timeout:7000,_currentState:l.INACTIVE,init:function(){this.init=bagofholding;this.reset();Event.listen(this._input,'keyup',this._update.bind(this));k.onUnload(this._onunload.bind(this));},reset:function(){clearTimeout(this._checkTimer);this._checkTimer=null;this._lastKeystrokeAt=null;this._currentState=l.INACTIVE;},setIgnoreKeys:function(m){this._ignoreKeys=j.createFrom(m);},_onunload:function(){if(this._currentState==l.TYPING)this._transition(l.QUITTING);},_update:function(event){var m=Event.getKeyCode(event),n=this._currentState;if(!this._ignoreKeys[m])if(i.getValue(this._input).trim().length===0){if(n==l.TYPING)this._transition(l.INACTIVE);}else if(n==l.TYPING){this._recordKeystroke();}else if(n==l.INACTIVE){this._transition(l.TYPING);this._recordKeystroke();}},_transition:function(m){this.reset();this._currentState=m;this.inform('change',m);},_recordKeystroke:function(){this._lastKeystrokeTime=Date.now();if(!this._checkTimer)this._checkTimer=this._checkTyping.bind(this).defer(this._timeout);},_checkTyping:function(){var m=this._lastKeystrokeTime+this._timeout,n=Date.now();if(n>m){this._transition(l.INACTIVE);}else{clearTimeout(this._checkTimer);this._checkTimer=this._checkTyping.bind(this).defer(m-n+10);}}});e.exports=l;});
__d("MercuryTypingReceiver",["Arbiter","MercuryParticipants","MercuryThreads","MercuryServerRequests","presence-arbiter-message","setTimeoutAcrossTransitions","TypingDetector","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('MercuryParticipants'),i=b('MercuryThreads'),j=b('MercuryServerRequests'),k=b('presence-arbiter-message'),l=b('setTimeoutAcrossTransitions'),m=b('TypingDetector'),n=c('MercuryConstants'),o,p={},q=30000,r=new g();function s(){return new Date().getTime();}function t(){o=null;var w=s(),x={};for(var y in p)if(p[y]<w-q){delete p[y];x[y]=false;}for(var z in x){r.inform('state-changed',x);break;}for(z in p){o=l(t,3000);return;}}function u(w){if(w in p){delete p[w];v(w);}}function v(w){var x={};x[w]=w in p;r.inform('state-changed',x);}g.subscribe(k.getArbiterMessageType('typ'),function(w,x){var y=x.obj,z='user:'+y.from;if(y.st==m.TYPING){var aa=z in p;p[z]=s();if(!o)o=l(t,3000);!aa&&v(z);}else if(y.st==m.INACTIVE)u(z);});j.subscribe('update-typing-state',function(w,x){var y=x.payload_source;if(y!=n.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE)return;var z=x.actions;if(!z||!z.length)return;var aa=n.MercuryActionType.USER_GENERATED_MESSAGE;z.forEach(function(ba){var ca=ba.thread_id;if(ba.action_type==aa&&i.getCanonicalUserInThread(ca)&&ba.author!=h.user)u(ca);});});e.exports=r;});
__d("ChatTabView",["event-extensions","function-extensions","Animation","Arbiter","ArbiterMixin","AvailableList","AvailableListConstants","ChatConfig","ChatPrivacyActionController","ChatTabMessagesView","ChatTabSheetController","ChatVisibility","css","Dialog","DOM","JSLogger","Keys","MercuryMessages","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreadMetadataRenderer","MercuryThreads","MercuryTypingReceiver","Parent","PresencePrivacy","TextAreaControl","Tooltip","TypingIndicator","URI","copyProperties","setIntervalAcrossTransitions","tx","ua","MercuryConstants","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Animation'),h=b('Arbiter'),i=b('ArbiterMixin'),j=b('AvailableList'),k=b('AvailableListConstants'),l=b('ChatConfig'),m=b('ChatPrivacyActionController'),n=b('ChatTabMessagesView'),o=b('ChatTabSheetController'),p=b('ChatVisibility'),q=b('css'),r=b('Dialog'),s=b('DOM'),t=b('JSLogger'),u=b('Keys'),v=b('MercuryMessages'),w=b('MercuryParticipants'),x=b('MercuryServerRequests'),y=b('MercuryThreadInformer'),z=b('MercuryThreadMetadataRenderer'),aa=b('MercuryThreads'),ba=b('MercuryTypingReceiver'),ca=b('Parent'),da=b('PresencePrivacy'),ea=b('TextAreaControl'),fa=b('Tooltip'),ga=b('TypingIndicator'),ha=b('URI'),ia=c('MercuryConstants'),ja=c('ChatTabTemplates'),ka=b('copyProperties'),la=b('setIntervalAcrossTransitions'),ma=b('tx'),na=b('ua'),oa=t.create('tab_view'),pa={};function qa(ab){return ab==k.ACTIVE||ab==k.IDLE;}function ra(){var ab=s.scry(document.body,'div.videoChatCallout');ab.forEach(s.remove);}function sa(ab,bb){var cb=s.$N('div');bb=bb.filter(function(db){return db!=w.user;});w.getMulti(bb,function(db){for(var eb in db){var fb=db[eb],gb=ja[':fb:mercury:chat:multichat-tooltip-item'].build();s.setContent(gb.getNode('name'),fb.name);var hb=w.getUserID(eb),ib=hb&&j.get(hb)==k.ACTIVE;q.conditionShow(gb.getNode('icon'),ib);q.conditionClass(gb.getNode('name'),'tooltipItemWithIcon',ib);s.appendContent(cb,gb.getRoot());}fa.set(ab,cb,'above','center');});}function ta(ab){var bb=x.tokenizeThreadID(ab);switch(bb.type){case 'user':return ja[':fb:mercury:chat:user-tab'].build();case 'group':return ja[':fb:mercury:chat:group-tab'].build();case 'live_listen':return ja[':fb:mercury:chat:live-listen-tab'].build();}return ja[':fb:mercury:chat:multichat-tab'].build();}var ua=null,va={};function wa(ab,bb){var cb=ab.getThreadID();if(bb){va[cb]=va[cb]||null;if(!ua)ua=la(xa,1300);}else{va[cb]&&va[cb].stop();ab.stopAnimation();delete va[cb];}}function xa(){var ab=true;for(var bb in va){var cb=ya.get(bb);if(cb){ab=false;va[bb]=cb.animateTitlebar();}else delete va[bb];}if(ab){clearInterval(ua);ua=null;}}function ya(ab,bb){if(bb)x.ensureThreadIsFetched(bb);this._threadID=ab;this._eventListeners=[];this._tabTemplate=ta(ab);this._tabElem=this._tabTemplate.getRoot();if(!(this._getNode instanceof Function))oa.log('getnode_undefined',{is_getnode_set:!!this._getNode,is_prototype_set:!!ya.prototype,is_window:window==this,is_chat_tab_view:this instanceof ya,ctor_name:this.constructor&&this.constructor.name});this._sheetController=new o(this._threadID,this._getNode('sheet'),this._tabElem);this._messagesView=null;var cb=this._getNode('conversationLink');if(cb){q.hide(cb);z.renderTitanLink(ab,cb,q.show.bind(q,cb));}if(aa.isMultichatThread(this._threadID)){var db=this._getNode('titlebarTextWrapper'),eb=db.parentNode;this._titlebarLink=s.$N('a',{href:'#'},db);q.addClass(this._titlebarLink,'titlebarLink');s.setContent(eb,this._titlebarLink);}this._nubController=new NubController().init(this._tabElem);ea.getInstance(this._getNode('input')).subscribe('resize',function(){this._nubController.flyoutContentChanged();}.bind(this));this._listen('closeButton','click',this._closeClicked);this._listen('titlebarCloseButton','click',this._closeClicked);this._listen('dockButton','click',this._nubClicked);this._listen('dockButton','keydown',this._dockKeyDown);this._listen('nubFlyoutTitlebar','click',this._titleClicked);this._listen('chatConv','click',this._chatConvClicked);this._listen('addFriendLink','click',this._addFriendLinkClicked,true);this._listen('addToThreadLink','click',this._addFriendLinkClicked,true);this._listen('clearWindowLink','click',this._clearHistory,true);this._listen('unsubscribeLink','click',this._unsubscribeLinkClicked,true);this._listen('videoCallLink','click',this._callClicked,true);this._listen('reportSpamLink','click',this._reportSpamClicked,true);this._listen('input','focus',this._focusTab);this._listen('input','blur',this._blurTab);if(na.firefox()){this._listen('input','keypress',this._inputKeyDown);}else this._listen('input','keydown',this._inputKeyDown);this._privacyLink=this._getNode('privacyLink');var fb=this._getCanonicalUserID();if(this._privacyLink){var gb=new m(fb,this._updatePrivacyLink.bind(this));this._eventListeners.push(Event.listen(this._privacyLink,'click',gb.togglePrivacy.bind(gb)));}if(fb){this._typingIndicator=new ga(fb,this._getNode('input'),'mercury-chat');w.get('fbid:'+fb,function(jb){var kb=this._getNode('typingIndicator'),lb=ma._("{name} is typing...",{name:jb.short_name});s.setContent(kb,lb);}.bind(this));}var hb=this._getNode('muteGroupLink');if(hb){var ib=aa.getCanonicalGroupInThread(this._threadID);if(ib)hb.setAttribute('ajaxify',ha(hb.getAttribute('ajaxify')).addQueryData({id:ib}));}pa[ab]=this;this.updateAvailableStatus();this.updateTab();}function za(){for(var ab in pa){pa[ab].updateAvailableStatus();pa[ab].updateMultichatTooltip();}}h.subscribe(['buddylist/availability-changed'],za);da.subscribe(['privacy-changed','privacy-availability-changed'],za);ba.subscribe('state-changed',function(ab,bb){for(var cb in bb){var db=pa[cb];db&&db.showTypingIndicator(bb[cb]);}});y.subscribe('threads-updated',function(ab,bb){for(var cb in pa)bb[cb]&&pa[cb].updateTab();});y.subscribe('threads-deleted',function(ab,bb){for(var cb in pa)ya.inform('thread-deleted',cb);});Function.mixin(ya,i,{get:function(ab){return pa[ab];}});ka(ya.prototype,{getThreadID:function(){return this._threadID;},isVisible:function(){return q.shown(this._tabElem);},setVisibleState:function(ab,bb){var cb=q.shown(this._tabElem),db=q.hasClass(this._tabElem,'opened');q.conditionShow(this._tabElem,ab);q.conditionClass(this._tabElem,'opened',bb);if(!(cb&&db)&&ab&&bb){if(!this._messagesView)this._messagesView=new n(this._threadID,this._getNode('chatConv'),this._getNode('conversation'));this._nubController.flyoutContentChanged();this._messagesView.scrollToBottom();}},focus:function(){var ab=q.hasClass(this._tabElem,'opened')?'input':'dockButton';this._getNode(ab).focus();},isFocused:function(){var ab=document.activeElement;return ca.byClass(ab,'fbMercuryChatTab')===this._tabElem;},setInput:function(ab){this._getNode('input').value=ab;},insertBefore:function(ab){s.insertBeforeTemp(ab._tabElem,this._tabElem);},appendTo:function(ab){s.appendContent(ab,this._tabElem);},nextTabIs:function(ab){var bb=ab&&ab._tabElem;return this._tabElem.nextSibling==bb;},destroy:function(){s.remove(this._tabElem);while(this._eventListeners.length)this._eventListeners.pop().remove();this._messagesView&&this._messagesView.destroy();this._sheetController.destroy();delete pa[this._threadID];Dock.unregisterNubController(this._nubController);},updateAvailableStatus:function(){var ab={active:false,mobile:false,blocked:false,chatOffline:false},bb=this._getCanonicalUserID();if(bb){var cb=j.get(bb);if(p.isOnline()){if(da.allows(bb)){ab.active=(cb==k.ACTIVE);ab.mobile=(cb==k.MOBILE);}else ab.blocked=true;}else ab.chatOffline=true;this._updateCallLink(cb);}for(var db in ab)q.conditionClass(this._tabElem,db,ab[db]);},updateTab:function(){aa.getThreadMeta(this._threadID,function(ab){if(!ab.is_subscribed){ya.inform('unsubscribed',this._threadID);return;}z.renderAndSeparatedParticipantList(this._threadID,[this._getNode('name'),this._getNode('titlebarText')],true,true);this._updateUnreadCount(ab);this.updateMultichatTooltip();}.bind(this));},updateMultichatTooltip:function(){if(aa.isMultichatThread(this._threadID))aa.getThreadMeta(this._threadID,function(ab){sa(this._titlebarLink,ab.participants);}.bind(this));},_getNode:function(ab){return this._tabTemplate.getNode(ab);},_getCanonicalUserID:function(){return aa.getCanonicalUserInThread(this._threadID);},_listen:function(ab,event,bb,cb){var db=this._getNode(ab);if(db){this._eventListeners.push(Event.listen(db,event,bb.bind(this)));}else if(!cb)throw new Error('Could not find node "'+ab+'"');},_closeClicked:function(ab){ya.inform('closed-tab',this._threadID);ab.prevent();},_nubClicked:function(){return ya.inform('nub-activated',this._threadID);},_dockKeyDown:function(event){if(event.keyCode===u.RETURN||event.keyCode===u.SPACE){ya.inform('nub-activated',this._threadID);event.kill();}else this._handleHotkeyPressed(event);},_handleHotkeyPressed:function(event){if(event.keyCode===u.ESC){ya.inform('esc-pressed',this._threadID);event.kill();}else if(event.keyCode===u.TAB){var ab=ya.inform('tab-pressed',{id:this._threadID,shiftPressed:event.shiftKey});!ab&&event.kill();}},_titleClicked:function(event){if(!ca.byClass(event.getTarget(),'uiSelector')&&!ca.byClass(event.getTarget(),'addToThread'))ya.inform('lower-activated',this._threadID);},_callClicked:function(ab){var bb=this._getCanonicalUserID();if(qa(j.get(bb)))ya.inform('video-call-clicked',{threadID:this._threadID,userID:bb,clickSource:'chat_tab_icon'});ab.prevent();},_addFriendLinkClicked:function(){this._sheetController.openAddFriendsSheet();},_clearHistory:function(){var ab=aa.getThreadMetaNow(this._threadID);if(ab){var bb=this._getCanonicalUserID();x.clearChat(this._threadID,bb,ab.timestamp);}},_unsubscribeLinkClicked:function(){var ab=[];ab.push({name:'unsubscribe',label:"Leave Conversation",handler:this._unsubscribeToThread.bind(this)});ab.push(r.CANCEL);new r().setTitle("Leave Conversation?").setBody("You will stop receiving messages from this conversation and people will see that you left.").setButtons(ab).show();},_reportSpamClicked:function(){var ab=this._getCanonicalUserID(),bb=ha('/ajax/chat/report.php').addQueryData({id:ab}).addQueryData({src:'top_report_link'});r.bootstrap(bb.toString(),null,false);},_focusTab:function(){q.addClass(this._tabElem,'focusedTab');ya.inform('focused',this._threadID);},_blurTab:function(){q.removeClass(this._tabElem,'focusedTab');},_inputKeyDown:function(event){if(event.keyCode===u.RETURN&&!event.shiftKey){var ab=this._getNode('input'),bb=ab.value||'';if(!/^\s*$/.test(bb))aa.getThreadMeta(this._threadID,function(cb){var db=v.constructUserGeneratedMessageObject(bb,ia.MercurySourceType.CHAT_WEB,this._threadID);if(aa.isEmptyLocalThread(this._threadID)){var eb=x.tokenizeThreadID(this._threadID);db.message_id=eb.value;db.specific_to_list=cb.participants;}v.sendMessage(db);this._getNode('input').value='';this._typingIndicator&&this._typingIndicator.resetState();}.bind(this));event.kill();}if(event.keyCode===u.DOWN&&event.shiftKey&&this._getNode('input').value===''){ya.inform('lower-activated',this._threadID);event.kill();return;}this._handleHotkeyPressed(event);},_chatConvClicked:function(){!s.getSelection()&&this.focus();},showTypingIndicator:function(ab){q.conditionClass(this._tabElem,'typing',ab);},_updateUnreadCount:function(ab){var bb=ab.unread_count;if(typeof bb!='undefined'){var cb=this._getNode('numMessages');q.conditionShow(cb,bb);if(l.get('chat_mark_read_on_focus')){wa(this,bb);}else q.conditionClass(this._tabElem,'highlightTab',bb);s.setContent(cb,bb);}},animateTitlebar:function(){return new g(this._getNode('nubFlyoutTitlebar')).from('backgroundColor','#6d84b4').to('backgroundColor','#3b5998').duration(500).checkpoint().to('backgroundColor','#6d84b4').duration(500).checkpoint().go();},stopAnimation:function(){this._getNode('nubFlyoutTitlebar').style.removeProperty('background-color');},_updateCallLink:function(ab){var bb=this._getNode('videoCallLink');if(p.isOnline()){var cb=this._getCanonicalUserID(),db='fbid:'+cb;w.get(db,function(eb){if(qa(ab)){fa.set(bb,ma._("Start a video call with {firstname}",{firstname:eb.short_name}));this._updateCallBackLinks(this._tabElem,true);}else{fa.set(bb,ma._("{firstname} is currently unavailable for video calling",{firstname:eb.short_name}));ra();this._updateCallBackLinks(this._tabElem,false);}}.bind(this));}else{fa.set(bb,"You must be online to make a call.");ra();this._updateCallBackLinks(document.body,false);}},_updateCallBackLinks:function(ab,bb){var cb=s.scry(ab,'a.callBackLink');if(bb){cb.forEach(q.show);}else cb.forEach(q.hide);},_updatePrivacyLink:function(ab){if(ab==m.OFFLINE){s.setContent(this._privacyLink,"Go online");}else{var bb=this._getCanonicalUserID(),cb='fbid:'+bb;w.get(cb,function(db){var eb=null;if(ab==m.BLOCKED){eb=ma._("Go Online to {name}",{name:db.short_name});}else eb=ma._("Go Offline to {name}",{name:db.short_name});s.setContent(this._privacyLink,eb);}.bind(this));}},_unsubscribeToThread:function(){if(aa.isEmptyLocalThread(this._threadID)){ya.inform('unsubscribed',this._threadID);}else{var ab=v.constructLogMessageObject(ia.MercurySourceType.CHAT_WEB,this._threadID,ia.MercuryLogMessageType.UNSUBSCRIBE,{});v.sendMessage(ab);}return true;}});e.exports=ya;});
__d("MercuryNotificationRenderer",["MercuryAssert","MercuryMessages","MercuryParticipants","MercuryThreads","tx"],function(a,b,c,d,e,f){var g=b('MercuryAssert'),h=b('MercuryMessages'),i=b('MercuryParticipants'),j=b('MercuryThreads'),k=b('tx');function l(m,n){g.isThreadID(m);j.getThreadMeta(m,function(o){h.getThreadMessages(m,1,function(p){var q=p.length&&p[p.length-1];if(q&&q.author!=i.user){i.get(q.author,function(r){if(o.name&&!o.is_canonical_live_listen){n(k._("{senderName} messaged {groupName}",{senderName:r.short_name,groupName:o.name}));}else n(k._("{name} messaged you",{name:r.short_name}));});}else n("New message!");});});}e.exports={renderDocumentTitle:l};});
__d("ChatTitleBarBlinker",["ChatActivity","DocumentTitle","JSLogger","math-extensions","MercuryThreadInformer","MercuryNotificationRenderer","PresenceState","MercuryTimestampTracker","MercuryUnseenState","UserActivity"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('DocumentTitle'),i=b('JSLogger'),j=b('math-extensions'),k=b('MercuryThreadInformer'),l=b('MercuryNotificationRenderer'),m=b('PresenceState'),n=b('MercuryTimestampTracker'),o=b('MercuryUnseenState'),p=b('UserActivity'),q=i.create('chat_title'),r=null,s=0,t=false;function u(){if(r){r.stop();r=null;return true;}return false;}function v(aa){var ba=aa||n.getLastUserMessageTimestamp();if(s<=ba){s=ba;if(u()||t)m.doSync();}}var w={blink:function(aa,ba){if(!r&&s<ba)l.renderDocumentTitle(aa,function(ca){if(!r)r=h.blink(ca);});},stopBlinking:function(){v();},blinkingElsewhere:function(){t=true;}};function x(aa){var ba=j.verifyNumber(aa.sb2);if(!ba||ba<=s)return null;return ba;}function y(aa){var ba=aa&&x(aa);if(ba){s=ba;q.debug('load',s);u();t=false;}}function z(aa){var ba=x(aa);if(!ba){q.debug('store',s);aa.sb2=s;t=false;}return aa;}m.registerStateStorer(z);m.registerStateLoader(y);k.subscribe('thread-read-changed',function(aa,ba){var ca=n.getLastUserMessageTimestamp(),da=0;for(var ea in ba)if(ba[ea].mark_as_read&&ba[ea].timestamp>=ca&&ba[ea].timestamp>da)da=ba[ea].timestamp;da&&v(da);});g.subscribe('activity',function(){v();});(function(){var aa=m.getInitial();if(aa)s=x(aa)||0;})();e.exports=w;});
__d("ChatNewMessageHandler",["ChatActivity","ChatConfig","ChatSound","ChatTabModel","ChatTabView","ChatTitleBarBlinker","JSLogger","MercuryAssert","MercuryThreads","MercuryUnseenState"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('ChatConfig'),i=b('ChatSound'),j=b('ChatTabModel'),k=b('ChatTabView'),l=b('ChatTitleBarBlinker'),m=b('JSLogger'),n=b('MercuryAssert'),o=b('MercuryThreads'),p=b('MercuryUnseenState'),q=m.create('chat_new_message');function r(t){o.changeThreadReadStatus(t,true);p.markThreadSeen(t);}var s={_raiseTab:function(t,u){var v=j.getTab(t),w=false;if(v){w=v.raised;}else{j.raiseTab(t,false);w=true;}u.to_new_tab=!v;u.to_raised_tab=!!w;},_notify:function(t,u,v){var w=k.get(t);v.view_is_visible=w.isVisible();v.view_is_focused=w.isFocused();if(!v.view_is_visible)q.debug('message_to_hidden');var x=g.isActive();v.is_active=x;if(x){if(w){var y=false;if(h.get('chat_mark_read_on_focus')){y=w.isVisible()&&w.isFocused();}else{var z=j.getTab(t).raised;y=w.isVisible()&&z;}if(y)r(t);}if(!w||!w.isFocused())i.messageReceived(u);}else{l.blink(t,u.timestamp);i.messageReceived(u);}l.blinkingElsewhere();},newMessage:function(t,u){n.isThreadID(t);var v={thread_id:t,message_id:u.message_id};this._raiseTab(t,v);this._notify(t,u,v);q.debug('message',v);}};e.exports=s;});
__d("ChatTabPolicy",["ChatBehavior","JSLogger","MercuryAssert","MercuryParticipants","MercuryThreads","MercuryUnseenState","PresencePrivacy","ShortProfiles","MercuryConstants"],function(a,b,c,d,e,f){var g=b('ChatBehavior'),h=b('JSLogger'),i=b('MercuryAssert'),j=b('MercuryParticipants'),k=b('MercuryThreads'),l=b('MercuryUnseenState'),m=b('PresencePrivacy'),n=b('ShortProfiles'),o=c('MercuryConstants'),p=h.create('tab_policy');function q(r){l.markThreadSeen(r);}e.exports={messageIsAllowed:function(r,s,t){var u=r.thread_id,v=s.message_id;i.isThreadID(u);i.isParticipantID(s.author);var w;if(r.mode==o.MercuryThreadMode.OBJECT_ORIGINATED){w={thread_id:u,message_id:v,mode:r.mode};p.debug('message_object_originated',w);return;}var x=o.MercurySourceType;if(s.source==x.EMAIL||s.source==x.TITAN_EMAIL_REPLY){w={thread_id:u,message_id:v,source:s.source};p.debug('message_source_not_allowed',w);return;}var y=j.getUserID(s.author);if(!y){p.debug('message_bad_author',{thread_id:u,message_id:v,user:y});return;}if(s.action_type!=o.MercuryActionType.USER_GENERATED_MESSAGE){w={thread_id:u,message_id:v,type:s.action_type};p.debug('message_non_user_generated',w);return;}if(r.is_canonical_user&&!g.notifiesUserMessages()){p.debug('message_jabber',{thread_id:u,message_id:v});q(u);return;}if(!r.is_canonical_group&&!r.is_canonical_live_listen&&r.folder!=o.MessagingTag.INBOX){p.debug('message_folder',{thread_id:u,message_id:v,folder:r.folder});return;}n.get(y,function(z){if(!m.allows(y)){p.debug('message_privacy',{thread_id:u,message_id:v,user:y});return;}if(!r.is_canonical_group&&!r.is_canonical_live_listen)if(z.type!='friend'){p.debug('message_non_friend',{thread_id:u,message_id:v,user:y});return;}t();});}};},3);
__d("ChatTabPresence",["Arbiter","AvailableList","ChatTabModel","MercuryThreads"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('ChatTabModel'),j=b('MercuryThreads'),k={};function l(m){var n=j.getCanonicalUserInThread(m);if(n)h.updateForID(n);}i.subscribe('chat/tabs-changed',function(event,m){m.tabs.forEach(function(n){if(n.raised&&!k[n.id])l(n.id);});k={};m.tabs.forEach(function(n){if(n.raised)k[n.id]=true;});});e.exports={};},3);
__d("ChatTabViewSelector",["Arbiter","copyProperties","css","DataStore","DOM","Menu","MercuryThreadInformer","MercuryThreads","MercuryThreadMetadataRenderer","Toggler","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('css'),j=b('DataStore'),k=b('DOM'),l=b('Menu'),m=b('MercuryThreadInformer'),n=b('MercuryThreads'),o=b('MercuryThreadMetadataRenderer'),p=b('Toggler'),q=c('ChatTabTemplates');function r(s){var t=q[':fb:chat:tab:selector'].build(),u=t.getRoot(),v=t.getNode('menu'),w=k.find(v,'.uiMenuInner'),x={},y=new NubController().init(u);i.hide(u);k.insertBeforeTemp(s,u);function z(ca){var da=0;for(var ea in x){var fa=x[ea],ga=n.getThreadMetaNow(ea),ha=fa.getNode('unreadCount'),ia=(ga&&ga.unread_count)||0;da+=ia;if(ia>9)ia='+';i.conditionClass(ha,'invisible_elem',!ia);k.setContent(ha,ia);}var ja=t.getNode('numMessages');i.conditionShow(ja,da);k.setContent(ja,da);}this.setTabData=function(ca){x={};if(ca.length<1){i.hide(u);return;}i.show(u);k.empty(w);ca.each(function(da){var ea=q[':fb:chat:tab:selector:item'].build();x[da.id]=ea;var fa=ea.getNode('content');o.renderAndSeparatedParticipantList(da.id,fa);k.prependContent(w,ea.getRoot());j.set(ea.getRoot(),'threadID',da.id);});y.flyoutContentChanged();k.setContent(t.getNode('numTabs'),ca.length);z();};function aa(event,ca){if(ca.menu!=v)return;var da=j.get(ca.item,'threadID');r.inform('selected',da);p.hide(u);}function ba(event,ca){l.register(v);}l.subscribe('select',aa.bind(this));p.listen('show',u,function(){g.inform('layer_shown',{type:'ChatTabSelector'});ba();});p.listen('hide',u,function(){g.inform('layer_hidden',{type:'ChatTabSelector'});});m.subscribe('threads-updated',z);}h(r,new g());e.exports=r;});
__d("ChatTabController",["Arbiter","AsyncRequest","ChatActivity","ChatConfig","ChatNewMessageHandler","ChatSound","ChatTabMessagesView","ChatTabModel","ChatTabPolicy","ChatTabPresence","ChatTabView","ChatTabViewSelector","ChatTitleBarBlinker","css","Dialog","JSLogger","MercuryMessages","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryUnseenState","VideoCallCore","ua"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('ChatActivity'),j=b('ChatConfig'),k=b('ChatNewMessageHandler'),l=b('ChatSound'),m=b('ChatTabMessagesView'),n=b('ChatTabModel'),o=b('ChatTabPolicy');b('ChatTabPresence');var p=b('ChatTabView'),q=b('ChatTabViewSelector'),r=b('ChatTitleBarBlinker'),s=b('css'),t=b('Dialog'),u=b('JSLogger'),v=b('MercuryMessages'),w=b('MercuryParticipants'),x=b('MercuryServerRequests'),y=b('MercuryThreadInformer'),z=b('MercuryThreads'),aa=b('MercuryUnseenState'),ba=b('VideoCallCore'),ca=b('ua'),da=j.get('tab_auto_close_timeout')||7200000,ea=u.create('tab_controller');function fa(na){z.changeThreadReadStatus(na,true);ga(na);}function ga(na){aa.markThreadSeen(na);}function ha(){var na=n.get();na.tabs.forEach(function(oa){var pa=p.get(oa.id);if(oa.raised&&pa&&pa.isVisible())fa(oa.id);});}function ia(){var na=n.get();na.tabs.forEach(function(oa){ga(oa.id);});}function ja(na,oa,pa){var qa=n.get().tabs;na+=oa?1:-1;while(na>=0&&na<qa.length){var ra=qa[na],sa=p.get(ra.id);if(sa&&sa.isVisible()&&(!pa||ra.raised)){sa.focus();return true;}na+=oa?1:-1;}return false;}function ka(na){function oa(ra){var sa=n.indexOf(ra);if(sa==-1||sa>=na.getMaxTabsToShow()-1){n.raiseAndPromoteTab(ra,true);}else n.raiseTab(ra,true);if(!j.get('chat_mark_read_on_focus'))fa(ra);var ta=p.get(ra);ta&&ta.focus();}function pa(ra,sa){var ta=n.get(),ua=na.getMaxTabsToShow(),va=n.indexOf(ra);n.closeTabAndDemote(ra,ua-2,sa);return va;}q.subscribe('selected',function(ra,sa){oa(sa);});g.subscribe('chat/open-tab',function(ra,sa){oa(sa.thread_id);});g.subscribe('page_transition',function(ra,sa){n.closeFragileTabs();});x.subscribe('model-update-completed',ia);if(!j.get('chat_mark_read_on_focus')){i.subscribe('activity',function(){na.checkWidth();ha();});na.subscribe('max-to-show-change-completed',function(){if(i.isActive())ha();});}else p.subscribe('focused',function(event,ra){fa(ra);});i.subscribe('idle',function(ra,sa){if(sa>da){var ta=n.get().tabs;ta.forEach(function(ua){var va=ua.id;z.getThreadMeta(va,function(wa){if(!wa.unread_count){ea.log('autoclose_idle_seen',{thread_id:va,idleness:sa});n.closeTab(va,'autoclose_idle_seen');}});});}});p.subscribe('nub-activated',function(ra,sa){oa(sa);});p.subscribe('lower-activated',function(ra,sa){n.lowerTab(sa);var ta=p.get(sa);ta&&ta.focus();});function qa(ra,sa){ba.showOutgoingCallDialog(sa.userID,sa.clickSource);n.lowerTab(sa.threadID);}p.subscribe('video-call-clicked',qa);m.subscribe('video-call-clicked',qa);p.subscribe('closed-tab',function(ra,sa){ea.log('close_view',{thread_id:sa});pa(sa,'close_view');return false;});p.subscribe('thread-deleted',function(ra,sa){ea.log('close_thread_deleted',{thread_id:sa});pa(sa,'close_thread_deleted');return false;});p.subscribe('unsubscribed',function(ra,sa){ea.log('close_view_unsubscribed',{thread_id:sa});pa(sa,'close_view_unsubscribed');return false;});p.subscribe('esc-pressed',function(ra,sa){ea.log('close_esc',{thread_id:sa});var ta=pa(sa,'close_esc');ja(ta-1,true,true)||ja(ta,false,true);});y.subscribe('messages-received',function(ra,sa){for(var ta in sa){var ua=sa[ta];for(var va=0;va<ua.length;va++){var wa=ua[va];if(wa.author!=w.user){if(!wa.is_unread){ea.debug('message_already_read',{action_id:wa.action_id,thread_id:wa.thread_id});continue;}z.getThreadMeta(ta,function(xa){o.messageIsAllowed(xa,wa,function(){k.newMessage(ta,wa);});});}}}});y.subscribe('thread-read-changed',function(ra,sa){for(var ta in sa)if(!sa[ta].mark_as_read){ea.log('autoclose_marked_unread',{thread_id:ta});n.closeTab(ta,'autoclose_marked_unread');}});p.subscribe('tab-pressed',function(ra,sa){return !ja(n.indexOf(sa.id),sa.shiftPressed);});g.subscribe(u.DUMP_EVENT,function(ra,sa){sa.chat_controller={auto_close_timeout:da};});}if(ca.firefox()){var la=function(){return s.getStyle(document.body,'overflowX')+' '+s.getStyle(document.body,'overflowY');},ma=la();document.documentElement.addEventListener('DOMAttrModified',function(event){if(event.getTarget()===document.documentElement&&(event.attrName==='class'||event.attrName==='style')){var na=la();if(na!==ma){ma=na;g.inform('overflow-applied-to-body');}}},false);}e.exports=ka;});
__d("MercuryLiveListenHandler",["Arbiter","Bootloader","ChannelConstants","ChatSound","JSLogger","MercuryServerRequests","MusicConstants","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Bootloader'),i=b('ChannelConstants'),j=b('ChatSound'),k=b('JSLogger'),l=b('MercuryServerRequests'),m=b('MusicConstants'),n=a.MusicEvents,o=c('MercuryConstants'),p=k.create('live_listen_handler');function q(w,x,y,z){var aa='live_listen:'+w.session_id,ba=w.session_id+':'+x+':'+y,ca={action_id:null,action_type:o.MercuryActionType.LOG_MESSAGE,author:'fbid:'+x,folder:false,forward_count:0,is_unread:false,log_message_data:z,log_message_type:o.MercuryLogMessageType.LIVE_LISTEN,message_id:ba,source:o.MercurySourceType.CHAT_WEB,thread_id:aa,threading_id:'',timestamp:y,timestamp_absolute:(new Date(y)).toLocaleString()};l.handleActionWaitForThread(ca,o.MercuryPayloadSource.CLIENT_LIVE_LISTEN);}function r(w,x){p.log('end_session',{type:w,data:x});}function s(w,x){var y=x.actor,z=x.session;if(z&&y){p.log('listener_update',{type:w,data:x});var aa={actor:y,music_type:'listener_update'};q(z,y.id,y.time*1000,aa);}}function t(w,x){var y=x.actor,z=x.session;if(z&&y&&y.time){p.log('begin_session',{type:w,data:x});var aa={actor:y,music_type:'begin_session'};q(z,y.id,y.time*1000,aa);}}function u(w,x){var y=x.session,z=x.song;if(y&&x.title&&x.body&&z){p.log('play_error',{type:w,data:x});var aa={title:x.title,body:x.body,song:z,music_type:'play_error'};q(y,y.leader,z.published*1000,aa);}}function v(w,x){var y=x.session,z=x.song?x.song:{};if(y&&z.title&&z.artist&&z.artist_url&&z.published&&z.published>=y.creation_time){p.log('song_play',{type:w,data:x});var aa={title:z.title,url:z.url,artist:z.artist,artist_url:z.artist_url,music_type:'song'};q(y,y.leader,z.published*1000,aa);}}n.subscribe([m.LIVE_LISTEN_OP.NOW_LEADING,m.LIVE_LISTEN_OP.NOW_LISTENING],t);n.subscribe([m.LIVE_LISTEN_OP.END_SESSION],r);n.subscribe([m.LIVE_LISTEN_OP.SONG_PLAYING],v);n.subscribe([m.LIVE_LISTEN_OP.LISTENER_UPDATE],s);n.subscribe([m.LIVE_LISTEN_OP.PLAY_ERROR],u);g.subscribe(i.getArbiterType('livelisten_update'),function(w,x){h.loadModules(['MusicLiveListen'],function(y){y.handleUpdate(x.obj);});});e.exports={};});
__d("MercuryStateCheck",["Arbiter","copyProperties","ChannelConnection","ChannelConstants","MercuryServerRequests"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('ChannelConnection'),j=b('ChannelConstants'),k=b('MercuryServerRequests'),l=h(new g(),{initialize:function(){g.subscribe(j.ON_INVALID_HISTORY,m);i.subscribe(i.CONNECTED,function(n,o){if(!o.init)m();});}});function m(){k.fetchMissedMessages();}l.initialize();e.exports=l;});
__d("ChatTabViewCoordinator",["Arbiter","ChatTabModel","ChatTabView","ChatTabViewSelector","css","VideoCallCore"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatTabModel'),i=b('ChatTabView'),j=b('ChatTabViewSelector'),k=b('css'),l=b('VideoCallCore');function m(n,o){var p=new j(n),q={},r=false;function s(x,y){var z={};y.tabs.forEach(function(ba){z[ba.id]=1;});for(var aa in q)if(!z[aa]){q[aa].destroy();delete(q[aa]);}t(y);u(y);}function t(x){var y=null;x.tabs.forEach(function(z){var aa=z.id,ba=false;if(!q[aa]){q[aa]=new i(aa,z.server_id);ba=true;}if(ba||!q[aa].nextTabIs(y))if(y){q[aa].insertBefore(y);}else q[aa].appendTo(n);y=q[aa];});}function u(x){var y=h.indexOf(x.promoted),z=o.getMaxTabsToShow(),aa;if(y==-1||y<z)y=z-1;var ba={};for(var ca=0;ca<x.tabs.length;ca++){aa=x.tabs[ca].id;var da=(ca<z-1)||(ca==y);if(da){ba[aa]=x.tabs[ca].raised;}else q[aa].setVisibleState(false,x.tabs[ca].raised);}for(aa in ba)q[aa].setVisibleState(true,ba[aa]);var ea=x.tabs.slice(z-1);ea.splice(y-z+1,1);p.setTabData(ea);w(x);}function v(x){for(var y=0,z=x.tabs.length;y<z;y++){var aa=x.tabs[y];if(aa.raised)if(aa.id===x.promoted||y<o.getMaxTabsToShow()-1)return true;}return false;}function w(x){var y=v(x);if(!y&&r){g.inform('layer_hidden',{type:'ChatTab'});r=false;}else if(y&&!r){g.inform('layer_shown',{type:'ChatTab'});r=true;}}if(l.isSupported())k.addClass(n,'videoCallEnabled');h.subscribe('chat/tabs-changed',s);o.subscribe('max-to-show-changed',function(){u(h.get());});s(null,h.get());}e.exports=m;});
__d("TabsViewport",["Arbiter","copyProperties","Parent","Vector"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('Parent'),j=b('Vector');function k(l){this._root=l;this._maxShown=1;this._initialized=false;this._width=j.getViewportDimensions().x;var m=this._recalculate.bind(this);g.subscribe(['sidebar/show','sidebar/hide','sidebar/initialized'],m);Event.listen(window,'resize',m);Dock.subscribe('resize',m);m();this._initialized=true;}k.prototype=h(new g(),{getMaxTabsToShow:function(){return this._maxShown;},checkWidth:function(){if(this._width!=j.getViewportDimensions().x)this._recalculate();},_recalculate:function(){this._width=j.getViewportDimensions().x;var l=j.getViewportDimensions().x;window.ChatSidebar&&(l-=window.ChatSidebar.getVisibleWidth());var m=j.getElementDimensions(this._root),n=j.getElementDimensions(i.byClass(this._root,'rNubContainer'));l-=(n.x-m.x);var o=264,p=Math.max(1,Math.floor((l-100)/o));if(p!=this._maxShown){this._maxShown=p;if(this._initialized){this.inform('max-to-show-changed',this._maxShown);this.inform('max-to-show-change-completed');}}}});e.exports=k;});
__d("ChatApp",["MercuryChannelHandler","ChatTabController","MercuryLiveListenHandler","MercuryStateCheck","ChatTabViewCoordinator","MercuryServerRequests","TabsViewport"],function(a,b,c,d,e,f){b('MercuryChannelHandler');b('ChatTabController');b('MercuryLiveListenHandler');b('MercuryStateCheck');var g=b('ChatTabController'),h=b('ChatTabViewCoordinator'),i=b('MercuryServerRequests'),j=b('TabsViewport');e.exports=function(k,l){i.handleUpdate(l);this.tabsViewport=new j(k);this.tabController=new g(this.tabsViewport);this.tabViewCoordinator=new h(k,this.tabsViewport);};});
__d("StickyArea",["event-extensions","ContextualLayer","css","DataStore","DOM","LayerHideOnTransition","Vector","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ContextualLayer'),h=b('css'),i=b('DataStore'),j=b('DOM'),k=b('LayerHideOnTransition'),l=b('Vector'),m=b('copyProperties');function n(p){var q=h.getScrollParent(p.parentNode);this.node=p;this._extracted=false;this._placeholder=j.$N('div',{className:'uiStickyAreaPlaceholder'});o.getInstance(q).register(this);}m(n.prototype,{update:function(){if(this._extracted){l.getElementDimensions(this._placeholder).setElementWidth(this.node);l.getElementDimensions(this.node).setElementHeight(this._placeholder);}else l.getElementDimensions(this.node).setElementWidth(this.node).setElementHeight(this._placeholder);return this;},setExtracted:function(p){if(p===this._extracted)return this;if(p){this.update();j.replace(this.node,this._placeholder);}else{h.setStyle(this.node,'height',null);h.setStyle(this.node,'width',null);j.replace(this._placeholder,this.node);}this._extracted=p;return this;},getOffsetTop:function(){return (this._extracted?this._placeholder:this.node).offsetTop;}});function o(p){this.node=p;this._areas=[];this._fixTarget=null;this._fixedArea=null;this._initialized=false;this._layer=new g().init().setInsertParent(this.node.parentNode).disableBehavior(k);this._listener=Event.listen(p,'scroll',this.update.bind(this));h.addClass(p,'uiStickyContainer');i.set(p,'StickyContainer',this);}o.getInstance=function(p){var q=i.get(p,'StickyContainer');return q||new o(p);};m(o.prototype,{isDisplayed:function(){return this.node.offsetParent!==null;},register:function(p){this._areas.push(p);return this;},update:function(){if(!this.isDisplayed())return this;var p=null,q=this,r=this.node.scrollTop;for(var s=0;s<this._areas.length;s++){var t=this._areas[s],u=t.getOffsetTop();if(u<=r){p=t;}else if(p){var v=l.getElementDimensions(p.node).y;if(u-v<r)q=t;break;}}this._init();if(this._fixedArea===p&&this._fixTarget===q){this._fixedArea&&this._fixedArea.update();}else{if(this._fixedArea&&this._fixedArea!==p)this._unfixArea(this._fixedArea);if(p)this._fixAreaTo(p,q);this._fixedArea=p;this._fixTarget=q;}return this;},destroy:function(){this._listener&&this._listener.remove();this._listener=null;},_init:function(){if(this._initialized)return;this._initialized=true;this._layer.updatePosition();},_fixAreaTo:function(p,q){this._layer.hide();p.setExtracted(true);if(q instanceof o){this._layer.setInsertParent(this.node.parentNode).setContext(this.node);}else this._layer.setInsertParent(this.node).setContext(q.node);this._layer.setContent(p.node).show();},_unfixArea:function(p){this._layer.hide();p.setExtracted(false);}});e.exports=n;});